<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="660px" preserveAspectRatio="none" style="width:1076px;height:660px;background:#FFFFFF;" version="1.1" viewBox="0 0 1076 660" width="1076px" zoomAndPan="magnify"><defs><filter height="300%" id="fiado8q6rz7si" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="582.5781" style="stroke:#A80036;stroke-width:1.0;" width="786.5" x="277" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="645.25" y="68.7139">Caliptra</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="44" x="1025.5" y="15.3809">Version 1</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="207" x="433.75" y="43.2637">Rotate Encapsulation Key</text><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="196.1094" style="stroke:#000000;stroke-width:2.0;" width="564" x="482" y="293.1563"/><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="149.7578" style="stroke:#000000;stroke-width:2.0;" width="520" x="501" y="325.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="39" x2="39" y1="147.3984" y2="559.9688"/><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="18" style="stroke:#A80036;stroke-width:1.0;" width="10" x="34" y="541.9688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="316" x2="316" y1="147.3984" y2="559.9688"/><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="43.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="311" y="250.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="517" x2="517" y1="147.3984" y2="559.9688"/><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="273.8125" style="stroke:#A80036;stroke-width:1.0;" width="10" x="512" y="281.1563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="576" x2="576" y1="147.3984" y2="559.9688"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="839" x2="839" y1="147.3984" y2="559.9688"/><rect fill="#FFFFFF" filter="url(#fiado8q6rz7si)" height="91.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="834" y="376.2109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1005" x2="1005" y1="147.3984" y2="559.9688"/><rect fill="#ADD8E6" filter="url(#fiado8q6rz7si)" height="331.5156" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1000" y="228.4531"/><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="5" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="12" y="97.1035">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="15.5" y="114.7129">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="26" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="281" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="288" y="132.3223">Mail Box</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="497" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="504" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="54" x="547" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="554" y="132.3223">DRBG</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="800" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="807" y="132.3223">Key Vault</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="950.5" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="973" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="983.5" y="114.7129">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="957.5" y="132.3223">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="5" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="12" y="581.502">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="15.5" y="599.1113">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="26" y="616.7207">FW</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="281" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="288" y="581.502">Mail Box</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="497" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="504" y="581.502">FW</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="54" x="547" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="40" x="554" y="581.502">DRBG</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="800" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="807" y="581.502">Key Vault</text><rect fill="#FEFECE" filter="url(#fiado8q6rz7si)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="950.5" y="559.9688"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="973" y="581.502">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="983.5" y="599.1113">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="957.5" y="616.7207">(KEM Keypair)</text><path d="M-0.25,160.3984 L-0.25,219.3984 L1043.75,219.3984 L1043.75,170.3984 L1033.75,160.3984 L-0.25,160.3984 " fill="#FBFB77" filter="url(#fiado8q6rz7si)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1033.75,160.3984 L1033.75,170.3984 L1043.75,170.3984 L1033.75,160.3984 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91" x="266" y="178.8936">Preconditions:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="355" x="278" y="195.2451">* KEM_HANDLE value is a KV slot containing a KEM keypair</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="487" x="278" y="211.5967">* KEM Keypair has been loaded into KV at power on or has been rotated by this API</text><line style="stroke:#008000;stroke-width:1.0;" x1="309" x2="299" y1="250.8047" y2="246.8047"/><line style="stroke:#008000;stroke-width:1.0;" x1="309" x2="299" y1="250.8047" y2="254.8047"/><line style="stroke:#008000;stroke-width:1.0;" x1="39" x2="310" y1="250.8047" y2="250.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="46" y="245.9482">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="215" x="79" y="245.9482">ROTATE_ENCAPSULATION_KEY(X)</text><line style="stroke:#008000;stroke-width:1.0;" x1="510" x2="500" y1="281.1563" y2="277.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="510" x2="500" y1="281.1563" y2="285.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="321" x2="511" y1="281.1563" y2="281.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="328" y="276.2998">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="361" y="276.2998">Command</text><path d="M482,293.1563 L543,293.1563 L543,301.1563 L533,311.1563 L482,311.1563 L482,293.1563 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="196.1094" style="stroke:#000000;stroke-width:2.0;" width="564" x="482" y="293.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="497" y="307.6514">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="243" x="558" y="306.5752">[kem_handle (XG has a Key Pair in KV slot G]</text><path d="M501,325.5078 L562,325.5078 L562,333.5078 L552,343.5078 L501,343.5078 L501,325.5078 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="149.7578" style="stroke:#000000;stroke-width:2.0;" width="520" x="501" y="325.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="516" y="340.0029">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="193" x="577" y="338.9268">[kem_algorithm = ecdh_secp384r1]</text><polygon fill="#FF0000" points="822,372.2109,832,376.2109,822,380.2109,826,376.2109" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="522" x2="828" y1="376.2109" y2="376.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="529" y="371.3545">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="228" x="562" y="371.3545">generate_ecdh_secp384r1(Key: Slot G)</text><polygon fill="#FF0000" points="587,402.5625,577,406.5625,587,410.5625,583,406.5625" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="581" x2="833" y1="406.5625" y2="406.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="593" y="401.7061">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="201" x="626" y="401.7061">Get random bytes for KEM keypair</text><polygon fill="#FF0000" points="988,432.9141,998,436.9141,988,440.9141,992,436.9141" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="844" x2="994" y1="436.9141" y2="436.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="851" y="432.0576">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="884" y="432.0576">New KEM keypair</text><polygon fill="#FF0000" points="533,463.2656,523,467.2656,533,471.2656,529,467.2656" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="527" x2="833" y1="467.2656" y2="467.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="539" y="462.4092">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="572" y="462.4092">done</text><polygon fill="#FF0000" points="327,537.9688,317,541.9688,327,545.9688,323,541.9688" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="321" x2="511" y1="541.9688" y2="541.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="333" y="528.9365">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="366" y="520.7607">Command Response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="370" y="537.1123">kem_handle is set to G</text><line style="stroke:#008000;stroke-width:1.0;" x1="44" x2="54" y1="541.9688" y2="537.9688"/><line style="stroke:#008000;stroke-width:1.0;" x1="44" x2="54" y1="541.9688" y2="545.9688"/><line style="stroke:#008000;stroke-width:1.0;" x1="44" x2="315" y1="541.9688" y2="541.9688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="61" y="528.9365">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="94" y="520.7607">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="55" x="94" y="537.1123">Complete</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="193" x="440.75" y="652.1777">Filename: rotate_encapsulation_key.uml</text><!--MD5=[e9c7aba598c1d540e6d214209a86bd9f]
@startuml

!include ocp_lock_utils.inc

!if ($show_title)
    Title "Rotate Encapsulation Key"
!endif

!if ($show_precond)
    note across
        <b>Preconditions:</b>
           * KEM_HANDLE value is a KV slot containing a KEM keypair
           * KEM Keypair has been loaded into KV at power on or has been rotated by this API
    end note
!endif

kemg++ $BUFFER_ACTIVATION

fw $async mb++ : ROTATE_ENCAPSULATION_KEY(X)

!if ($show_api)
    note right mb
        | <b>Field   | <b>Size | <b>Definition |
        | chksum     | u32     | Little endian |
        | kem_handle | u32     | Handle for old KEM keypair held in KMB memory|
    end note
!endif

mb $async cfw++ : Command

!if ($show_msg_parsing)
    cfw $sync mb : Get command
    mb- -
    $self("cfw", "Determine Command")
!else
    mb- -
!endif

alt kem_handle (XG has a Key Pair in KV slot G

    alt kem_algorithm = ecdh_secp384r1
        cfw $sync kv++: generate_ecdh_secp384r1(Key: Slot G)
        kv $sync rand: Get random bytes for KEM keypair
        kv $sync kemg : New KEM keypair
        !if ($show_done)
            kv $sync cfw- - : done
        !else
            kv- -
        !endif
    end
end

cfw $sync mb : Command Response\n kem_handle is set to G
& mb $async fw++ : Command\nComplete

!if ($show_api)
    note right mb
        | <b>Field   | <b>Size | <b>Definition |
        | chksum     | u32     | Little endian |
        | fips_status| u32     | Indicates if the command is FIPS approved or an error |
        | kem_handle | u32     | Handle for new KEM keypair held in KMB memory |
    end note
!endif
cfw- -


@enduml

@startuml









	autonumber 1 1  "<b>[000]"

	!pragma teoz true

    participant "Remote Key\nManagement Service" as rkms


    participant "Host" as host


    participant "Storage\nDevice\nFW" as fw

    box "Caliptra"
    	participant "Mail Box" as mb
    	participant "ROM" as crom
    	participant "FW" as cfw
    	participant "ROM to FW\nHandoff Data" as hoff
        participant "DRBG" as rand
        participant "DMA Engine" as dma
        participant "Key Vault" as kv
        participant "Key Vault\nFuses" as fuses
        participant "Key Vault\nStorage Root Key" as gsrk
        participant "Key Vault\nSlot A\n(Storage Root Key)" as srk
        participant "Key Vault\nSlot B\n(PMEK Secret)" as pmeks
        participant "Key Vault\nSlot F\n(DICE Alias Key)\necdsa_secp384r1_sha384" as dice
        participant "Key Vault\nSlot G\n(KEM Keypair)" as kemg
        participant "Key Vault\nSlot W\n(Temporary)" as tempw
        participant "Key Vault\nSlot X\n(MEK Seed)" as meks
        participant "Key Vault\nSlot Y\n(Temporary)" as tempy
        participant "Key Vault\nSlot Z\n(Temporary)" as tempz
        participant "Key Vault\nTemp Memory" as tempmem
    end box

    box "Encryption Engine"
        participant "SFR\nInterface" as sfr
        participant "Control" as ee
        participant "Key Cache" as kc
    end box

    box "Media"
        participant "Create new\Storage Root Key\non NVM subsystem reset" as csrk
        participant "Destroy all\Storage Root Keys\non NVM subsystem reset" as dsrk
    end box

    hide unlinked
	footer Filename: rotate_encapsulation_key.uml

	header Version 1


    Title "Rotate Encapsulation Key"

    note across
        <b>Preconditions:</b>
           * KEM_HANDLE value is a KV slot containing a KEM keypair
           * KEM Keypair has been loaded into KV at power on or has been rotated by this API
    end note

kemg++ #lightblue

fw -[#green]>> mb++ : ROTATE_ENCAPSULATION_KEY(X)


mb -[#green]>> cfw++ : Command

    mb- -

alt kem_handle (XG has a Key Pair in KV slot G

    alt kem_algorithm = ecdh_secp384r1
        cfw -[#red]> kv++: generate_ecdh_secp384r1(Key: Slot G)
        kv -[#red]> rand: Get random bytes for KEM keypair
        kv -[#red]> kemg : New KEM keypair
            kv -[#red]> cfw- - : done
    end
end

cfw -[#red]> mb : Command Response\n kem_handle is set to G
& mb -[#green]>> fw++ : Command\nComplete

cfw- -


@enduml

PlantUML version 1.2021.7(Sun May 23 06:40:07 MDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>