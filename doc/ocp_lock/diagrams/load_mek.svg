<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2132px" preserveAspectRatio="none" style="width:1592px;height:2132px;background:#FFFFFF;" version="1.1" viewBox="0 0 1592 2132" width="1592px" zoomAndPan="magnify"><defs><filter height="300%" id="f1gs8963ppyfsm" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="2054.5078" style="stroke:#A80036;stroke-width:1.0;" width="1125" x="152" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="689.5" y="68.7139">Caliptra</text><rect fill="#DDDDDD" height="2054.5078" style="stroke:#A80036;stroke-width:1.0;" width="241.5" x="1279" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="115" x="1342.25" y="68.7139">Encryption Engine</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="44" x="1541.5" y="15.3809">Version 1</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="84" x="762.75" y="43.2637">Load MEK</text><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="1435.5234" style="stroke:#000000;stroke-width:2.0;" width="1549.5" x="8" y="385.5625"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="225.8125" style="stroke:#000000;stroke-width:2.0;" width="819" x="363" y="417.9141"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="209.1094" style="stroke:#000000;stroke-width:2.0;" width="1016.5" x="344" y="889.5391"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="58.7031" style="stroke:#000000;stroke-width:2.0;" width="972.5" x="363" y="1025.9453"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="267.1641" style="stroke:#000000;stroke-width:2.0;" width="972.5" x="363" y="1116.6484"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="138.1094" style="stroke:#000000;stroke-width:2.0;" width="1169.5" x="363" y="1505.8672"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="58" x2="58" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="50.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="53" y="1981.1953"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="191" x2="191" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="43.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="186" y="299.8594"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="379" x2="379" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="1696.6875" style="stroke:#A80036;stroke-width:1.0;" width="10" x="374" y="330.2109"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="634" x2="634" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="147.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="629" y="1167.3516"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="731" x2="731" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="726" y="501.3203"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="726" y="712.7813"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="60.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="726" y="1873.7891"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="992" x2="992" y1="147.3984" y2="2031.8984"/><rect fill="#ADD8E6" filter="url(#f1gs8963ppyfsm)" height="1754.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="987" y="277.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1119" x2="1119" y1="147.3984" y2="2031.8984"/><rect fill="#ADD8E6" filter="url(#f1gs8963ppyfsm)" height="1298.7656" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1114" y="605.375"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1110" x2="1128" y1="1895.1406" y2="1913.1406"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1110" x2="1128" y1="1913.1406" y2="1895.1406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1224.5" x2="1224.5" y1="147.3984" y2="2031.8984"/><rect fill="#ADD8E6" filter="url(#f1gs8963ppyfsm)" height="1087.3047" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1219.5" y="816.8359"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1215.5" x2="1233.5" y1="1895.1406" y2="1913.1406"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1215.5" x2="1233.5" y1="1913.1406" y2="1895.1406"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1319.5" x2="1319.5" y1="147.3984" y2="2031.8984"/><rect fill="#FFFFFF" filter="url(#f1gs8963ppyfsm)" height="1385.4688" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1314.5" y="277.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1484.5" x2="1484.5" y1="147.3984" y2="2031.8984"/><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="24" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="31" y="97.1035">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="34.5" y="114.7129">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="45" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="156" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="163" y="132.3223">Mail Box</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="359" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="366" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="92" x="586" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="593" y="132.3223">DMA Engine</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="692" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="699" y="132.3223">Key Vault</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="922" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="960" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="971.5" y="114.7129">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="929" y="132.3223">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="90" x="1072" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1087" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1099" y="114.7129">Slot X</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="1079" y="132.3223">(MEK Seed)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1176" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1192.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1204" y="114.7129">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1183" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="69" x="1283" y="93.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="1303.5" y="114.7129">SFR</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="1290" y="132.3223">Interface</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="60" x="1452.5" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="1459.5" y="132.3223">Control</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="24" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="31" y="2053.4316">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="34.5" y="2071.041">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="45" y="2088.6504">FW</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="156" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="163" y="2053.4316">Mail Box</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="359" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="366" y="2053.4316">FW</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="92" x="586" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="78" x="593" y="2053.4316">DMA Engine</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="692" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="699" y="2053.4316">Key Vault</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="922" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="960" y="2053.4316">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="971.5" y="2071.041">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="929" y="2088.6504">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="90" x="1072" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1087" y="2053.4316">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1099" y="2071.041">Slot X</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="76" x="1079" y="2088.6504">(MEK Seed)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1176" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1192.5" y="2053.4316">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1204" y="2071.041">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1183" y="2088.6504">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="69" x="1283" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="28" x="1303.5" y="2053.4316">SFR</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="1290" y="2071.041">Interface</text><rect fill="#FEFECE" filter="url(#f1gs8963ppyfsm)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="60" x="1452.5" y="2031.8984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="46" x="1459.5" y="2053.4316">Control</text><path d="M30,160.3984 L30,268.3984 L1512,268.3984 L1512,170.3984 L1502,160.3984 L30,160.3984 " fill="#FBFB77" filter="url(#f1gs8963ppyfsm)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1502,160.3984 L1502,170.3984 L1512,170.3984 L1502,160.3984 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91" x="111.25" y="178.8936">Preconditions:</text><ellipse cx="116.75" cy="190.6016" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="561" x="124.25" y="195.2451">The following sequence may or may not have occurred prior: Zero or more MIX_PMEK commands</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="115.25" y="211.5967"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="111.25" y="227.9482">Notes:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="1299" x="119.25" y="244.2998">* The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="444" x="119.25" y="260.6514">* This sequence is focused on successful execution of operations by the KV.</text><line style="stroke:#008000;stroke-width:1.0;" x1="184" x2="174" y1="299.8594" y2="295.8594"/><line style="stroke:#008000;stroke-width:1.0;" x1="184" x2="174" y1="299.8594" y2="303.8594"/><line style="stroke:#008000;stroke-width:1.0;" x1="58" x2="185" y1="299.8594" y2="299.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="65" y="295.0029">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="98" y="295.0029">LOAD_MEK</text><line style="stroke:#008000;stroke-width:1.0;" x1="372" x2="362" y1="330.2109" y2="326.2109"/><line style="stroke:#008000;stroke-width:1.0;" x1="372" x2="362" y1="330.2109" y2="334.2109"/><line style="stroke:#008000;stroke-width:1.0;" x1="196" x2="373" y1="330.2109" y2="330.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="203" y="325.3545">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="236" y="325.3545">Command</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="426" y1="360.5625" y2="360.5625"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="426" x2="426" y1="360.5625" y2="373.5625"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="385" x2="426" y1="373.5625" y2="373.5625"/><polygon fill="#FF0000" points="395,369.5625,385,373.5625,395,377.5625,391,373.5625" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="355.7061">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="181" x="424" y="355.7061">Use KV Slot X for deriving MEK</text><path d="M8,385.5625 L69,385.5625 L69,393.5625 L59,403.5625 L8,403.5625 L8,385.5625 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1435.5234" style="stroke:#000000;stroke-width:2.0;" width="1549.5" x="8" y="385.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="23" y="400.0576">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="361" x="84" y="398.9814">[Storage Root Key exists and Encryption Engin has become ready]</text><path d="M363,417.9141 L424,417.9141 L424,425.9141 L414,435.9141 L363,435.9141 L363,417.9141 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="225.8125" style="stroke:#000000;stroke-width:2.0;" width="819" x="363" y="417.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="378" y="432.4092">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="286" x="439" y="431.333">[MEK is not initialized (i.e., no PMEK in the final MEK)]</text><polygon fill="#FF0000" points="714,497.3203,724,501.3203,714,505.3203,718,501.3203" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="720" y1="501.3203" y2="501.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="480.1123">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="134" x="424" y="463.7607">HMAC512(Key: Slot A,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="488" y="480.1123">Key Data: "MEK Seed",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="488" y="496.4639">Destination: Slot X)</text><polygon fill="#FF0000" points="975,527.6719,985,531.6719,975,535.6719,979,531.6719" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="981" y1="531.6719" y2="531.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="526.8154">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="776" y="526.8154">Get Storage Root Key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="778" y1="562.0234" y2="562.0234"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="778" x2="778" y1="562.0234" y2="575.0234"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="737" x2="778" y1="575.0234" y2="575.0234"/><polygon fill="#FF0000" points="747,571.0234,737,575.0234,747,579.0234,743,575.0234" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="557.167">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="155" x="776" y="557.167">HMAC512 slot A with Data</text><polygon fill="#FF0000" points="1102,601.375,1112,605.375,1102,609.375,1106,605.375" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="1108" y1="605.375" y2="605.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="600.5186">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="776" y="600.5186">HMAC512 result MEK Seed with Storage Root Key</text><polygon fill="#FF0000" points="395,631.7266,385,635.7266,395,639.7266,391,635.7266" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="389" x2="725" y1="635.7266" y2="635.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="401" y="630.8701">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="434" y="630.8701">done</text><polygon fill="#FF0000" points="714,708.7813,724,712.7813,714,716.7813,718,712.7813" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="720" y1="712.7813" y2="712.7813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="691.5732">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="424" y="675.2217">HMAC512(Key : Slox X,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="488" y="691.5732">Data String: "DEK" || dek,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="488" y="707.9248">Destination : Slot Y)</text><polygon fill="#FF0000" points="1102,739.1328,1112,743.1328,1102,747.1328,1106,743.1328" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="1108" y1="743.1328" y2="743.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="738.2764">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="776" y="738.2764">Get MEK Seed</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="778" y1="773.4844" y2="773.4844"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="778" x2="778" y1="773.4844" y2="786.4844"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="737" x2="778" y1="786.4844" y2="786.4844"/><polygon fill="#FF0000" points="747,782.4844,737,786.4844,747,790.4844,743,786.4844" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="768.6279">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="776" y="768.6279">HMAC512 Data Key String with Key</text><polygon fill="#FF0000" points="1207.5,812.8359,1217.5,816.8359,1207.5,820.8359,1211.5,816.8359" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="1213.5" y1="816.8359" y2="816.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="811.9795">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="776" y="811.9795">HMAC512 result MEK</text><polygon fill="#FF0000" points="395,843.1875,385,847.1875,395,851.1875,391,847.1875" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="389" x2="725" y1="847.1875" y2="847.1875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="401" y="842.3311">[013]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="434" y="842.3311">done</text><polygon fill="#FF0000" points="1302.5,873.5391,1312.5,877.5391,1302.5,881.5391,1306.5,877.5391" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="877.5391" y2="877.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="872.6826">[014]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="424" y="872.6826">Read Control Reg</text><path d="M344,889.5391 L405,889.5391 L405,897.5391 L395,907.5391 L344,907.5391 L344,889.5391 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="209.1094" style="stroke:#000000;stroke-width:2.0;" width="1016.5" x="344" y="889.5391"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="359" y="904.0342">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="186" x="420" y="902.958">[(DN == 1b || ERR == 1b || EXE == 1b)]</text><polygon fill="#FF0000" points="1302.5,936.2422,1312.5,940.2422,1302.5,944.2422,1306.5,940.2422" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="940.2422" y2="940.2422"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="935.3857">[015]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="424" y="935.3857">Write Control Reg (DN = 1b)</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="426" y1="970.5938" y2="970.5938"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="426" x2="426" y1="970.5938" y2="983.5938"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="385" x2="426" y1="983.5938" y2="983.5938"/><polygon fill="#FF0000" points="395,979.5938,385,983.5938,395,987.5938,391,983.5938" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="965.7373">[016]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="424" y="965.7373">Start timeout</text><polygon fill="#FF0000" points="1302.5,1009.9453,1312.5,1013.9453,1302.5,1017.9453,1306.5,1013.9453" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1013.9453" y2="1013.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1009.0889">[017]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="424" y="1009.0889">Read Control Reg</text><path d="M363,1025.9453 L818,1025.9453 L818,1033.9453 L808,1043.9453 L363,1043.9453 L363,1025.9453 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="58.7031" style="stroke:#000000;stroke-width:2.0;" width="972.5" x="363" y="1025.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="410" x="378" y="1040.4404">loop until (rdy_timeout or (DN == 0b &amp;&amp; ERR == 0b &amp;&amp; EXE == 0b)</text><polygon fill="#FF0000" points="1302.5,1072.6484,1312.5,1076.6484,1302.5,1080.6484,1306.5,1076.6484" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1076.6484" y2="1076.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1071.792">[018]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="424" y="1071.792">Read Control Reg</text><path d="M363,1116.6484 L485,1116.6484 L485,1124.6484 L475,1134.6484 L363,1134.6484 L363,1116.6484 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="267.1641" style="stroke:#000000;stroke-width:2.0;" width="972.5" x="363" y="1116.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="77" x="378" y="1131.1436">in any order</text><line style="stroke:#008000;stroke-width:1.0;" x1="627" x2="617" y1="1167.3516" y2="1163.3516"/><line style="stroke:#008000;stroke-width:1.0;" x1="627" x2="617" y1="1167.3516" y2="1171.3516"/><line style="stroke:#008000;stroke-width:1.0;" x1="384" x2="628" y1="1167.3516" y2="1167.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1162.4951">[019]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="424" y="1162.4951">MEK Write (Slot: Y)</text><polygon fill="#FF0000" points="1207.5,1193.7031,1217.5,1197.7031,1207.5,1201.7031,1211.5,1197.7031" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="639" x2="1213.5" y1="1197.7031" y2="1197.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="646" y="1192.8467">[020]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="679" y="1192.8467">Read MEK</text><polygon fill="#FF0000" points="1302.5,1224.0547,1312.5,1228.0547,1302.5,1232.0547,1306.5,1228.0547" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="639" x2="1308.5" y1="1228.0547" y2="1228.0547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="646" y="1223.1982">[021]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="64" x="679" y="1223.1982">Write MEK</text><path d="M938.5,1241.0547 L938.5,1283.0547 L1310.5,1283.0547 L1310.5,1251.0547 L1300.5,1241.0547 L938.5,1241.0547 " fill="#FBFB77" filter="url(#f1gs8963ppyfsm)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1300.5,1241.0547 L1300.5,1251.0547 L1310.5,1251.0547 L1300.5,1241.0547 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="351" x="944.5" y="1259.5498">If Encryption Engine uses a MEK which is smaller then MEK</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="270" x="944.5" y="1275.9014">than the Encryption Engine truncates the MEK</text><line style="stroke:#008000;stroke-width:1.0;" x1="384" x2="394" y1="1315.1094" y2="1311.1094"/><line style="stroke:#008000;stroke-width:1.0;" x1="384" x2="394" y1="1315.1094" y2="1319.1094"/><line style="stroke:#008000;stroke-width:1.0;" x1="384" x2="628" y1="1315.1094" y2="1315.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="401" y="1310.2529">[022]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="434" y="1310.2529">complete</text><polygon fill="#FF0000" points="1302.5,1341.4609,1312.5,1345.4609,1302.5,1349.4609,1306.5,1345.4609" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1345.4609" y2="1345.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1340.6045">[023]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="424" y="1340.6045">Write Aux</text><polygon fill="#FF0000" points="1302.5,1371.8125,1312.5,1375.8125,1302.5,1379.8125,1306.5,1375.8125" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1375.8125" y2="1375.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1370.9561">[024]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="89" x="424" y="1370.9561">Write Metadata</text><polygon fill="#FF0000" points="1302.5,1416.1641,1312.5,1420.1641,1302.5,1424.1641,1306.5,1420.1641" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1420.1641" y2="1420.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1415.3076">[025]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="329" x="424" y="1415.3076">Write Control Reg (CMD = Load_MEK, DN = 0, EXE = 1)</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="426" y1="1450.5156" y2="1450.5156"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="426" x2="426" y1="1450.5156" y2="1463.5156"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="385" x2="426" y1="1463.5156" y2="1463.5156"/><polygon fill="#FF0000" points="395,1459.5156,385,1463.5156,395,1467.5156,391,1463.5156" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1445.6592">[026]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="424" y="1445.6592">Start timeout</text><polygon fill="#FF0000" points="1302.5,1489.8672,1312.5,1493.8672,1302.5,1497.8672,1306.5,1493.8672" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1493.8672" y2="1493.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1489.0107">[027]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="424" y="1489.0107">Read Control Reg</text><path d="M363,1505.8672 L632,1505.8672 L632,1513.8672 L622,1523.8672 L363,1523.8672 L363,1505.8672 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="138.1094" style="stroke:#000000;stroke-width:2.0;" width="1169.5" x="363" y="1505.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="224" x="378" y="1520.3623">loop until (cmd_timeout or DN = 1b)</text><polygon fill="#FF0000" points="1335.5,1601.625,1325.5,1605.625,1335.5,1609.625,1331.5,1605.625" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1329.5" x2="1483.5" y1="1605.625" y2="1605.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1341.5" y="1576.2412">[028]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="1374.5" y="1551.7139">Write Control Reg</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="56" x="1374.5" y="1568.0654">(DN = 1b,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="61" x="1378.5" y="1584.417">ERR = 0b,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="1378.5" y="1600.7686">EXE = 0b)</text><polygon fill="#FF0000" points="1302.5,1631.9766,1312.5,1635.9766,1302.5,1639.9766,1306.5,1635.9766" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1308.5" y1="1635.9766" y2="1635.9766"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1631.1201">[029]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="424" y="1631.1201">Read Control Reg</text><polygon fill="#FF0000" points="1307.5,1676.3281,1317.5,1680.3281,1307.5,1684.3281,1311.5,1680.3281" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="1313.5" y1="1680.3281" y2="1680.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1675.4717">[030]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="163" x="424" y="1675.4717">Write Control Reg (DN = 1b)</text><path d="M897.5,1693.3281 L897.5,1719.3281 L1310.5,1719.3281 L1310.5,1703.3281 L1300.5,1693.3281 L897.5,1693.3281 " fill="#FBFB77" filter="url(#f1gs8963ppyfsm)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1300.5,1693.3281 L1300.5,1703.3281 L1310.5,1703.3281 L1300.5,1693.3281 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="392" x="903.5" y="1711.8232">Reset the SFR interface for next operation - not waiting for response</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="426" y1="1800.0859" y2="1800.0859"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="426" x2="426" y1="1800.0859" y2="1813.0859"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="385" x2="426" y1="1813.0859" y2="1813.0859"/><polygon fill="#FF0000" points="395,1809.0859,385,1813.0859,395,1817.0859,391,1813.0859" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1770.7021">[031]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="424" y="1746.1748">Mark that the sequence</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="424" y="1762.5264">of an Initialize MEK then</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="203" x="424" y="1778.8779">zero or more MIX_PMEK sequence</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="74" x="428" y="1795.2295">is completed</text><polygon fill="#FF0000" points="714,1869.7891,724,1873.7891,714,1877.7891,718,1873.7891" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="384" x2="720" y1="1873.7891" y2="1873.7891"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="391" y="1860.7568">[032]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="424" y="1852.5811">Purge_key(Key: Slot X,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="488" y="1868.9326">Key : Slot Y)</text><polygon fill="#FF0000" points="1102,1900.1406,1112,1904.1406,1102,1908.1406,1106,1904.1406" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="1108" y1="1904.1406" y2="1904.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="1899.2842">[033]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="776" y="1899.2842">Purge</text><polygon fill="#FF0000" points="1207.5,1900.1406,1217.5,1904.1406,1207.5,1908.1406,1211.5,1904.1406" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="736" x2="1213.5" y1="1904.1406" y2="1904.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="743" y="1899.2842">[034]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="780" y="1899.2842"/><polygon fill="#FF0000" points="395,1930.4922,385,1934.4922,395,1938.4922,391,1934.4922" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="389" x2="725" y1="1934.4922" y2="1934.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="401" y="1929.6357">[035]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="434" y="1929.6357">done</text><line style="stroke:#008000;stroke-width:1.0;" x1="191" x2="201" y1="2013.8984" y2="2009.8984"/><line style="stroke:#008000;stroke-width:1.0;" x1="191" x2="201" y1="2013.8984" y2="2017.8984"/><line style="stroke:#008000;stroke-width:1.0;" x1="191" x2="373" y1="2013.8984" y2="2013.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="208" y="1984.5146">[036]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="241" y="1959.9873">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="241" y="1976.3389">response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="241" y="1992.6904">(Status = Control Reg</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="301" y="2009.042">Error field)</text><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="73" y1="2013.8984" y2="2009.8984"/><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="73" y1="2013.8984" y2="2017.8984"/><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="190" y1="2013.8984" y2="2013.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="80" y="2000.8662">[037]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="113" y="1992.6904">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="113" y="2009.042">complete</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="118" x="745.75" y="2124.1074">Filename: load_mek.uml</text><!--MD5=[97f0d904eab3c84ecf482ed871b4fc29]
@startuml

!include ocp_lock_utils.inc

!if ($show_title)
    Title "Load MEK"
!endif

!if ($show_precond)
    note across
        <b>Preconditions:</b>
        * The following sequence may or may not have occurred prior: Zero or more MIX_PMEK commands

        <b>Notes:</b>
          * The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.
          * This sequence is focused on successful execution of operations by the KV.
    end note
!endif


srk++ $BUFFER_ACTIVATION
sfr++

fw $async mb++ : LOAD_MEK

!if ($show_api)
    note right mb
        | <b>Field     | <b>Size | <b>Definition |
        | chksum       | u32     | Little endian |
        | metadata     | u8[20]  | Metadata for MEK to load into the drive crypto engine (i.e. NSID + LBA range) |
        | aux_metadata | u8[32]  | Auxiliary metadata for the MEK (optional; i.e. operation mode) |
        | rdy_timeout  | u32     | Timeout in ms for encryption engine to become ready for a new command |
        | cmd_timeout  | u32     | Timeout in ms for command to crypto engine to complete |
        | dek          | u8[32]  | Controller-supplied "data encryption key"\n    * May be a C_PIN-derived secret in Opal or a per-MEK value in KPIO |
    end note
!endif

mb $async cfw++ : Command

!if ($show_msg_parsing)
    cfw $sync mb : Get command
    mb- -
    $self("cfw", "Determine command")
!else
    mb- -
!endif

$self("cfw", "Use KV Slot X for deriving MEK")


alt Storage Root Key exists and Encryption Engin has become ready

    alt MEK is not initialized (i.e., no PMEK in the final MEK)
        cfw $sync kv++: HMAC512(Key: Slot A,\n                Key Data: "MEK Seed",\n                Destination: Slot X)
        kv $sync srk: Get Storage Root Key
        kv $sync kv: HMAC512 slot A with Data
        kv $sync meks: HMAC512 result MEK Seed with Storage Root Key
        meks++ $BUFFER_ACTIVATION
        !if ($show_done)
            kv $sync cfw- - : done
        !else
            kv- -
        !endif
    end

    cfw $sync kv++: HMAC512(Key : Slox X,\n                Data String: "DEK" || dek,\n                Destination : Slot Y)
    kv $sync meks: Get MEK Seed
    kv $sync kv: HMAC512 Data Key String with Key
    kv $sync tempy: HMAC512 result MEK
    tempy++ $BUFFER_ACTIVATION
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif


    cfw $sync sfr : Read Control Reg

    alt (DN == 1b || ERR == 1b || EXE == 1b)
        cfw $sync sfr : Write Control Reg (DN = 1b)

        cfw $sync cfw : Start timeout
        cfw $sync sfr : Read Control Reg
        group loop until (rdy_timeout or (DN == 0b && ERR == 0b && EXE == 0b)

            cfw $sync sfr : Read Control Reg
        end
    end

    group in any order
        cfw $async dma++ : MEK Write (Slot: Y)
        dma $sync tempy : Read MEK
        dma $sync sfr : Write MEK
        note left sfr
            If Encryption Engine uses a MEK which is smaller then MEK
            than the Encryption Engine truncates the MEK
        end note
        dma $async cfw- - : complete

        cfw $sync sfr : Write Aux
        cfw $sync sfr : Write Metadata
    end

    cfw $sync sfr : Write Control Reg (CMD = Load_MEK, DN = 0, EXE = 1)

    cfw $sync cfw : Start timeout

    cfw $sync sfr : Read Control Reg

    group loop until (cmd_timeout or DN = 1b)
        ee $sync sfr- - : Write Control Reg\n(DN = 1b,\n ERR = 0b,\n EXE = 0b)
        cfw $sync sfr : Read Control Reg
    end
    sfr- -

    cfw $sync sfr : Write Control Reg (DN = 1b)
    note left sfr: Reset the SFR interface for next operation - not waiting for response

    $self("cfw", "Mark that the sequence\nof an Initialize MEK then\nzero or more MIX_PMEK sequence\n is completed")
end

cfw $sync kv++: Purge_key(Key: Slot X,\n                Key : Slot Y)
kv $sync meks !! : Purge
& kv $sync tempy !!
!if ($show_done)
    kv $sync cfw- - : done
!else
    kv- -
!endif

cfw $async mb : Command\nresponse\n(Status = Control Reg\n               Error field)
& mb $async fw++ : Command\ncomplete
cfw- -

!if ($show_api)
    note right mb
        | <b>Field    | <b>Size | <b>Definition |
        | chksum      | u32     | Little endian |
        | fips_status | u32     | Indicates if the command is FIPS approved or an error |
    end note
!endif

@enduml

@startuml









	autonumber 1 1  "<b>[000]"

	!pragma teoz true

    participant "Remote Key\nManagement Service" as rkms


    participant "Host" as host


    participant "Storage\nDevice\nFW" as fw

    box "Caliptra"
    	participant "Mail Box" as mb
    	participant "ROM" as crom
    	participant "FW" as cfw
    	participant "ROM to FW\nHandoff Data" as hoff
        participant "DRBG" as rand
        participant "DMA Engine" as dma
        participant "Key Vault" as kv
        participant "Key Vault\nFuses" as fuses
        participant "Key Vault\nStorage Root Key" as gsrk
        participant "Key Vault\nSlot A\n(Storage Root Key)" as srk
        participant "Key Vault\nSlot B\n(PMEK Secret)" as pmeks
        participant "Key Vault\nSlot F\n(DICE Alias Key)\necdsa_secp384r1_sha384" as dice
        participant "Key Vault\nSlot G\n(KEM Keypair)" as kemg
        participant "Key Vault\nSlot W\n(Temporary)" as tempw
        participant "Key Vault\nSlot X\n(MEK Seed)" as meks
        participant "Key Vault\nSlot Y\n(Temporary)" as tempy
        participant "Key Vault\nSlot Z\n(Temporary)" as tempz
        participant "Key Vault\nTemp Memory" as tempmem
    end box

    box "Encryption Engine"
        participant "SFR\nInterface" as sfr
        participant "Control" as ee
        participant "Key Cache" as kc
    end box

    box "Media"
        participant "Create new\Storage Root Key\non NVM subsystem reset" as csrk
        participant "Destroy all\Storage Root Keys\non NVM subsystem reset" as dsrk
    end box

    hide unlinked
	footer Filename: load_mek.uml

	header Version 1


    Title "Load MEK"

    note across
        <b>Preconditions:</b>
        * The following sequence may or may not have occurred prior: Zero or more MIX_PMEK commands

        <b>Notes:</b>
          * The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.
          * This sequence is focused on successful execution of operations by the KV.
    end note


srk++ #lightblue
sfr++

fw -[#green]>> mb++ : LOAD_MEK


mb -[#green]>> cfw++ : Command

    mb- -

	   cfw -[#red]> cfw : Use KV Slot X for deriving MEK
	   ||0||


alt Storage Root Key exists and Encryption Engin has become ready

    alt MEK is not initialized (i.e., no PMEK in the final MEK)
        cfw -[#red]> kv++: HMAC512(Key: Slot A,\n                Key Data: "MEK Seed",\n                Destination: Slot X)
        kv -[#red]> srk: Get Storage Root Key
        kv -[#red]> kv: HMAC512 slot A with Data
        kv -[#red]> meks: HMAC512 result MEK Seed with Storage Root Key
        meks++ #lightblue
            kv -[#red]> cfw- - : done
    end

    cfw -[#red]> kv++: HMAC512(Key : Slox X,\n                Data String: "DEK" || dek,\n                Destination : Slot Y)
    kv -[#red]> meks: Get MEK Seed
    kv -[#red]> kv: HMAC512 Data Key String with Key
    kv -[#red]> tempy: HMAC512 result MEK
    tempy++ #lightblue
        kv -[#red]> cfw- - : done


    cfw -[#red]> sfr : Read Control Reg

    alt (DN == 1b || ERR == 1b || EXE == 1b)
        cfw -[#red]> sfr : Write Control Reg (DN = 1b)

        cfw -[#red]> cfw : Start timeout
        cfw -[#red]> sfr : Read Control Reg
        group loop until (rdy_timeout or (DN == 0b && ERR == 0b && EXE == 0b)

            cfw -[#red]> sfr : Read Control Reg
        end
    end

    group in any order
        cfw -[#green]>> dma++ : MEK Write (Slot: Y)
        dma -[#red]> tempy : Read MEK
        dma -[#red]> sfr : Write MEK
        note left sfr
            If Encryption Engine uses a MEK which is smaller then MEK
            than the Encryption Engine truncates the MEK
        end note
        dma -[#green]>> cfw- - : complete

        cfw -[#red]> sfr : Write Aux
        cfw -[#red]> sfr : Write Metadata
    end

    cfw -[#red]> sfr : Write Control Reg (CMD = Load_MEK, DN = 0, EXE = 1)

    cfw -[#red]> cfw : Start timeout

    cfw -[#red]> sfr : Read Control Reg

    group loop until (cmd_timeout or DN = 1b)
        ee -[#red]> sfr- - : Write Control Reg\n(DN = 1b,\n ERR = 0b,\n EXE = 0b)
        cfw -[#red]> sfr : Read Control Reg
    end
    sfr- -

    cfw -[#red]> sfr : Write Control Reg (DN = 1b)
    note left sfr: Reset the SFR interface for next operation - not waiting for response

    	   cfw -[#red]> cfw : Mark that the sequence\nof an Initialize MEK then\nzero or more MIX_PMEK sequence\n is completed
	   ||0||
end

cfw -[#red]> kv++: Purge_key(Key: Slot X,\n                Key : Slot Y)
kv -[#red]> meks !! : Purge
& kv -[#red]> tempy !!
    kv -[#red]> cfw- - : done

cfw -[#green]>> mb : Command\nresponse\n(Status = Control Reg\n               Error field)
& mb -[#green]>> fw++ : Command\ncomplete
cfw- -


@enduml

PlantUML version 1.2021.7(Sun May 23 06:40:07 MDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>