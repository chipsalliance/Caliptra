<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="2696px" preserveAspectRatio="none" style="width:1683px;height:2696px;background:#FFFFFF;" version="1.1" viewBox="0 0 1683 2696" width="1683px" zoomAndPan="magnify"><defs><filter height="300%" id="f1axfy42rpaf5u" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="2618.5938" style="stroke:#A80036;stroke-width:1.0;" width="1452" x="184" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="885" y="68.7139">Caliptra</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="44" x="1632" y="15.3809">Version 1</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="118" x="791" y="43.2637">Rewrap PMEK</text><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="2159.0703" style="stroke:#000000;stroke-width:2.0;" width="1640" x="8" y="293.1563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="58" x2="58" y1="147.3984" y2="2595.9844"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="18" style="stroke:#A80036;stroke-width:1.0;" width="10" x="53" y="2577.9844"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="223" x2="223" y1="147.3984" y2="2595.9844"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="43.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="218" y="250.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="411" x2="411" y1="147.3984" y2="2595.9844"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="2309.8281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="406" y="281.1563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="766" x2="766" y1="147.3984" y2="2595.9844"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="150.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="437.2656"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="150.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="651.0781"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="167.1094" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="925.5938"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="164.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="1155.7578"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="164.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="1427.9219"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="164.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="1655.7344"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="1927.8984"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="150.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="2169.7109"/><rect fill="#FFFFFF" filter="url(#f1axfy42rpaf5u)" height="60.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="761" y="2383.5234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1004" x2="1004" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="2367.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="999" y="228.4531"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1138.5" x2="1138.5" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="2367.5313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1133.5" y="228.4531"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1251.5" x2="1251.5" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="851.5469" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1246.5" y="1562.3281"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1242.5" x2="1260.5" y1="2404.875" y2="2422.875"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1242.5" x2="1260.5" y1="2422.875" y2="2404.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1358.5" x2="1358.5" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="1856.2031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1353.5" y="557.6719"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1349.5" x2="1367.5" y1="2404.875" y2="2422.875"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1349.5" x2="1367.5" y1="2422.875" y2="2404.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1465.5" x2="1465.5" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="1642.3906" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1460.5" y="771.4844"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1456.5" x2="1474.5" y1="2404.875" y2="2422.875"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1456.5" x2="1474.5" y1="2422.875" y2="2404.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1578" x2="1578" y1="147.3984" y2="2595.9844"/><rect fill="#ADD8E6" filter="url(#f1axfy42rpaf5u)" height="1533.6328" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1573" y="1062.3516"/><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="24" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="31" y="97.1035">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="34.5" y="114.7129">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="45" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="188" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="195" y="132.3223">Mail Box</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="391" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="398" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="727" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="734" y="132.3223">Key Vault</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="934" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="972" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="983.5" y="114.7129">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="941" y="132.3223">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1084" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1106.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1117" y="114.7129">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1091" y="132.3223">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1203" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1219.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="1229" y="114.7129">Slot W</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1210" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1310" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1326.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1338" y="114.7129">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1317" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1417" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1433.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1445.5" y="114.7129">Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1424" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="104" x="1524" y="93.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1546" y="114.7129">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="1531" y="132.3223">Temp Memory</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="24" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="31" y="2617.5176">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="34.5" y="2635.127">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="45" y="2652.7363">FW</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="188" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="195" y="2617.5176">Mail Box</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="391" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="398" y="2617.5176">FW</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="727" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="734" y="2617.5176">Key Vault</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="934" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="972" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="983.5" y="2635.127">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="941" y="2652.7363">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1084" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1106.5" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1117" y="2635.127">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1091" y="2652.7363">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1203" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1219.5" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="41" x="1229" y="2635.127">Slot W</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1210" y="2652.7363">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1310" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1326.5" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1338" y="2635.127">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1317" y="2652.7363">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1417" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1433.5" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1445.5" y="2635.127">Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1424" y="2652.7363">(Temporary)</text><rect fill="#FEFECE" filter="url(#f1axfy42rpaf5u)" height="49.2188" style="stroke:#A80036;stroke-width:1.5;" width="104" x="1524" y="2595.9844"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1546" y="2617.5176">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="90" x="1531" y="2635.127">Temp Memory</text><path d="M19,160.3984 L19,219.3984 L1617,219.3984 L1617,170.3984 L1607,160.3984 L19,160.3984 " fill="#FBFB77" filter="url(#f1axfy42rpaf5u)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1607,160.3984 L1607,170.3984 L1617,170.3984 L1607,160.3984 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91" x="632.5" y="178.8936">Preconditions:</text><ellipse cx="638" cy="190.6016" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="645.5" y="195.2451">Access Shared Secret already availble in a slot in KV</text><ellipse cx="638" cy="206.9531" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="345" x="645.5" y="211.5967">unlocking key already in a slot and generated on each reset</text><line style="stroke:#008000;stroke-width:1.0;" x1="216" x2="206" y1="250.8047" y2="246.8047"/><line style="stroke:#008000;stroke-width:1.0;" x1="216" x2="206" y1="250.8047" y2="254.8047"/><line style="stroke:#008000;stroke-width:1.0;" x1="58" x2="217" y1="250.8047" y2="250.8047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="65" y="245.9482">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="103" x="98" y="245.9482">REWRAP_PMEK</text><line style="stroke:#008000;stroke-width:1.0;" x1="404" x2="394" y1="281.1563" y2="277.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="404" x2="394" y1="281.1563" y2="285.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="228" x2="405" y1="281.1563" y2="281.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="235" y="276.2998">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="268" y="276.2998">Command</text><path d="M8,293.1563 L69,293.1563 L69,301.1563 L59,311.1563 L8,311.1563 L8,293.1563 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="2159.0703" style="stroke:#000000;stroke-width:2.0;" width="1640" x="8" y="293.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="23" y="307.6514">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="139" x="84" y="306.5752">[Storage Root Key exists]</text><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1652" x="5" y="342.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="342.6836" y2="342.6836"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="345.6836" y2="345.6836"/><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="126" x="768" y="331.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="774" y="349.0029">Get Access Key 1</text><polygon fill="#FF0000" points="749,433.2656,759,437.2656,749,441.2656,753,437.2656" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="437.2656" y2="437.2656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="407.8818">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="456" y="383.3545">Decaps(KEM Pair : kem_handle (g),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="220" x="504" y="399.7061">KEM ciphertext : kem_ciphertext from</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="608" y="416.0576">wrapped_access_key_1</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="504" y="432.4092">Destination : Slot Y)</text><polygon fill="#FF0000" points="1121.5,463.6172,1131.5,467.6172,1121.5,471.6172,1125.5,467.6172" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1127.5" y1="467.6172" y2="467.6172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="462.7607">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="811" y="462.7607">Get KEM Keypair</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="514.3203" y2="514.3203"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="514.3203" y2="527.3203"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="527.3203" y2="527.3203"/><polygon fill="#FF0000" points="782,523.3203,772,527.3203,782,531.3203,778,527.3203" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="501.2881">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="811" y="493.1123">Decap KEM Ciphertext</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="71" x="811" y="509.4639">with Keypair</text><polygon fill="#FF0000" points="1341.5,553.6719,1351.5,557.6719,1341.5,561.6719,1345.5,557.6719" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="557.6719" y2="557.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="552.8154">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="811" y="552.8154">Put Shared Secret</text><polygon fill="#FF0000" points="427,584.0234,417,588.0234,427,592.0234,423,588.0234" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="588.0234" y2="588.0234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="583.167">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="583.167">done</text><polygon fill="#FF0000" points="749,647.0781,759,651.0781,749,655.0781,753,651.0781" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="651.0781" y2="651.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="629.8701">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="118" x="456" y="613.5186">Unwrap(Key : Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="209" x="504" y="629.8701">Key Data : wrapped_access_key_1,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="504" y="646.2217">Destination : Slot Z)</text><polygon fill="#FF0000" points="1341.5,677.4297,1351.5,681.4297,1341.5,685.4297,1345.5,681.4297" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="681.4297" y2="681.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="676.5732">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="811" y="676.5732">Get Shared Secret</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="728.1328" y2="728.1328"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="728.1328" y2="741.1328"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="741.1328" y2="741.1328"/><polygon fill="#FF0000" points="782,737.1328,772,741.1328,782,745.1328,778,741.1328" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="715.1006">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="811" y="706.9248">Unwrap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="811" y="723.2764">wrapped_access_key_1</text><polygon fill="#FF0000" points="1448.5,767.4844,1458.5,771.4844,1448.5,775.4844,1452.5,771.4844" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="771.4844" y2="771.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="766.6279">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="811" y="766.6279">Put Access Key 1</text><polygon fill="#FF0000" points="427,797.8359,417,801.8359,427,805.8359,423,801.8359" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="801.8359" y2="801.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="796.9795">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="796.9795">done</text><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1652" x="5" y="831.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="831.0117" y2="831.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="834.0117" y2="834.0117"/><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="126" x="768" y="819.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="108" x="774" y="837.3311">Get Access Key 2</text><polygon fill="#FF0000" points="749,921.5938,759,925.5938,749,929.5938,753,925.5938" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="925.5938" y2="925.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="896.21">[013]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="456" y="871.6826">Unwrap(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="245" x="504" y="888.0342">Key Data: double_encrypted_access_key,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="504" y="904.3857">Destination Memory:</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="85" x="628" y="904.3857">Put in memory</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="628" y="920.7373"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="76" x="628" y="920.7373">as not a key)</text><polygon fill="#FF0000" points="1341.5,951.9453,1351.5,955.9453,1341.5,959.9453,1345.5,955.9453" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="955.9453" y2="955.9453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="951.0889">[014]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="108" x="811" y="951.0889">Get Shared Secret</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="1019" y2="1019"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="1019" y2="1032"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="1032" y2="1032"/><polygon fill="#FF0000" points="782,1028,772,1032,782,1036,778,1032" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="997.792">[015]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="43" x="811" y="981.4404">Unwrap</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="179" x="811" y="997.792">double_encrypted_access_key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="811" y="1014.1436">with Slot Y</text><polygon fill="#FF0000" points="1561,1058.3516,1571,1062.3516,1561,1066.3516,1565,1062.3516" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1567" y1="1062.3516" y2="1062.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1057.4951">[016]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="145" x="811" y="1057.4951">Encrypted Access Key 2</text><polygon fill="#FF0000" points="427,1088.7031,417,1092.7031,427,1096.7031,423,1092.7031" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="1092.7031" y2="1092.7031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="1087.8467">[017]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="1087.8467">done</text><polygon fill="#FF0000" points="749,1151.7578,759,1155.7578,749,1159.7578,753,1155.7578" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="1155.7578" y2="1155.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="1134.5498">[018]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="456" y="1118.1982">Unwrap(Key : Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="504" y="1134.5498">Key Data : Temp Memory,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="504" y="1150.9014">Destination : Slot Y)</text><polygon fill="#FF0000" points="1448.5,1182.1094,1458.5,1186.1094,1448.5,1190.1094,1452.5,1186.1094" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="1186.1094" y2="1186.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1181.2529">[019]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="811" y="1181.2529">Get Access Key 1</text><polygon fill="#FF0000" points="1561,1212.4609,1571,1216.4609,1561,1220.4609,1565,1216.4609" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1567" y1="1216.4609" y2="1216.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1211.6045">[020]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="159" x="811" y="1211.6045">Get encrypted_access_key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="1246.8125" y2="1246.8125"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="1246.8125" y2="1259.8125"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="1259.8125" y2="1259.8125"/><polygon fill="#FF0000" points="782,1255.8125,772,1259.8125,782,1263.8125,778,1259.8125" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1241.9561">[021]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="186" x="811" y="1241.9561">Unwrap encrypted access key 2</text><polygon fill="#FF0000" points="1341.5,1286.1641,1351.5,1290.1641,1341.5,1294.1641,1345.5,1290.1641" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="1290.1641" y2="1290.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1285.3076">[022]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="811" y="1285.3076">Put Access Key 2</text><polygon fill="#FF0000" points="427,1316.5156,417,1320.5156,427,1324.5156,423,1320.5156" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="1320.5156" y2="1320.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="1315.6592">[023]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="1315.6592">done</text><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1652" x="5" y="1349.6914"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="1349.6914" y2="1349.6914"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="1352.6914" y2="1352.6914"/><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="279" x="691.5" y="1338.5156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="261" x="697.5" y="1356.0107">Create PMEK wrapping/unwrapping Keys</text><polygon fill="#FF0000" points="749,1423.9219,759,1427.9219,749,1431.9219,753,1427.9219" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="1427.9219" y2="1427.9219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="1406.7139">[024]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="456" y="1390.3623">HMAC512_Slots(Key : Slot A,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="556" y="1406.7139">Data Key : Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="556" y="1423.0654">Destination : Slot W)</text><polygon fill="#FF0000" points="987,1454.2734,997,1458.2734,987,1462.2734,991,1458.2734" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="993" y1="1458.2734" y2="1458.2734"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1453.417">[025]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="811" y="1453.417">Get Storage Root Key</text><polygon fill="#FF0000" points="1448.5,1484.625,1458.5,1488.625,1448.5,1492.625,1452.5,1488.625" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="1488.625" y2="1488.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1483.7686">[026]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="811" y="1483.7686">Get Access Key 1</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="1518.9766" y2="1518.9766"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="1518.9766" y2="1531.9766"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="1531.9766" y2="1531.9766"/><polygon fill="#FF0000" points="782,1527.9766,772,1531.9766,782,1535.9766,778,1531.9766" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1514.1201">[027]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="811" y="1514.1201">HMAC512 slot A and Slot Z</text><polygon fill="#FF0000" points="1234.5,1558.3281,1244.5,1562.3281,1234.5,1566.3281,1238.5,1562.3281" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1240.5" y1="1562.3281" y2="1562.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1557.4717">[028]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="811" y="1557.4717">HMAC512 result Encryption Key for old PMEK</text><polygon fill="#FF0000" points="427,1588.6797,417,1592.6797,427,1596.6797,423,1592.6797" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="1592.6797" y2="1592.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="1587.8232">[029]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="1587.8232">done</text><polygon fill="#FF0000" points="749,1651.7344,759,1655.7344,749,1659.7344,753,1655.7344" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="1655.7344" y2="1655.7344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="1634.5264">[030]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="456" y="1618.1748">HMAC512_Slots(Key : Slot A,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="556" y="1634.5264">Data Key : Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="556" y="1650.8779">Destination : Slot Z)</text><polygon fill="#FF0000" points="987,1682.0859,997,1686.0859,987,1690.0859,991,1686.0859" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="993" y1="1686.0859" y2="1686.0859"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1681.2295">[031]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="811" y="1681.2295">Get System Root Key</text><polygon fill="#FF0000" points="1341.5,1712.4375,1351.5,1716.4375,1341.5,1720.4375,1345.5,1716.4375" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="1716.4375" y2="1716.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1711.5811">[032]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="811" y="1711.5811">Get Access Key 2</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="1746.7891" y2="1746.7891"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="1746.7891" y2="1759.7891"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="1759.7891" y2="1759.7891"/><polygon fill="#FF0000" points="782,1755.7891,772,1759.7891,782,1763.7891,778,1759.7891" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1741.9326">[033]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="162" x="811" y="1741.9326">HMAC512 slot A and Slot Y</text><polygon fill="#FF0000" points="1448.5,1786.1406,1458.5,1790.1406,1448.5,1794.1406,1452.5,1790.1406" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="1790.1406" y2="1790.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1785.2842">[034]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="277" x="811" y="1785.2842">HMAC512 result New Encryption Key for PMEK</text><polygon fill="#FF0000" points="427,1816.4922,417,1820.4922,427,1824.4922,423,1820.4922" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="1820.4922" y2="1820.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="1815.6357">[035]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="1815.6357">done</text><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1652" x="5" y="1849.668"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="1849.668" y2="1849.668"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="1852.668" y2="1852.668"/><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="81" x="790.5" y="1838.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="63" x="796.5" y="1855.9873">Get PMEK</text><polygon fill="#FF0000" points="749,1923.8984,759,1927.8984,749,1931.8984,753,1927.8984" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="1927.8984" y2="1927.8984"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="1906.6904">[036]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="456" y="1890.3389">Unwrap(Key : Slot W,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="504" y="1906.6904">Key Data: locked_pmek</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="117" x="504" y="1923.042">Destination : Slot Y)</text><polygon fill="#FF0000" points="1234.5,1954.25,1244.5,1958.25,1234.5,1962.25,1238.5,1958.25" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1240.5" y1="1958.25" y2="1958.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1953.3936">[037]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="811" y="1953.3936">Encryption Key for old PMEK</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="1988.6016" y2="1988.6016"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="1988.6016" y2="2001.6016"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="2001.6016" y2="2001.6016"/><polygon fill="#FF0000" points="782,1997.6016,772,2001.6016,782,2005.6016,778,2001.6016" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="1983.7451">[038]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="811" y="1983.7451">Unwrap locked_pmek</text><polygon fill="#FF0000" points="1341.5,2027.9531,1351.5,2031.9531,1341.5,2035.9531,1345.5,2031.9531" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="2031.9531" y2="2031.9531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2027.0967">[039]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="38" x="811" y="2027.0967">PMEK</text><polygon fill="#FF0000" points="427,2058.3047,417,2062.3047,427,2066.3047,423,2062.3047" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="2062.3047" y2="2062.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="2057.4482">[040]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="2057.4482">done</text><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1652" x="5" y="2091.4805"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="2091.4805" y2="2091.4805"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1657" y1="2094.4805" y2="2094.4805"/><rect fill="#EEEEEE" filter="url(#f1axfy42rpaf5u)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="171" x="745.5" y="2080.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="153" x="751.5" y="2097.7998">Create the locked PMEK</text><polygon fill="#FF0000" points="749,2165.7109,759,2169.7109,749,2173.7109,753,2169.7109" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="2169.7109" y2="2169.7109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="2148.5029">[041]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="456" y="2132.1514">Wrap(Key: Slot Z,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="508" y="2148.5029">Data Key : Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="508" y="2164.8545">Destination : new_locked_pmek)</text><polygon fill="#FF0000" points="1448.5,2196.0625,1458.5,2200.0625,1448.5,2204.0625,1452.5,2200.0625" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="2200.0625" y2="2200.0625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2195.2061">[042]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="143" x="811" y="2195.2061">Get New Encryption Key</text><polygon fill="#FF0000" points="1341.5,2226.4141,1351.5,2230.4141,1341.5,2234.4141,1345.5,2230.4141" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="2230.4141" y2="2230.4141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2225.5576">[043]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="811" y="2225.5576">Get PMEK</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="813" y1="2277.1172" y2="2277.1172"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="813" x2="813" y1="2277.1172" y2="2290.1172"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="772" x2="813" y1="2290.1172" y2="2290.1172"/><polygon fill="#FF0000" points="782,2286.1172,772,2290.1172,782,2294.1172,778,2290.1172" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2264.085">[044]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="149" x="811" y="2255.9092">Wrap slot Y with Slot Z to</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="180" x="811" y="2272.2607">generate new_encrypted_pmek</text><polygon fill="#FF0000" points="427,2316.4688,417,2320.4688,427,2324.4688,423,2320.4688" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="2320.4688" y2="2320.4688"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="2315.6123">[045]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="466" y="2315.6123">new_encrypted_pmek</text><polygon fill="#FF0000" points="749,2379.5234,759,2383.5234,749,2387.5234,753,2383.5234" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="416" x2="755" y1="2383.5234" y2="2383.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="423" y="2362.3154">[046]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="456" y="2345.9639">Purge_key(Key: Slot W,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="75" x="520" y="2362.3154">Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="520" y="2378.667">Key : Slot Z)</text><polygon fill="#FF0000" points="1234.5,2409.875,1244.5,2413.875,1234.5,2417.875,1238.5,2413.875" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1240.5" y1="2413.875" y2="2413.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2409.0186">[047]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="811" y="2409.0186">Purge</text><polygon fill="#FF0000" points="1341.5,2409.875,1351.5,2413.875,1341.5,2417.875,1345.5,2413.875" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1347.5" y1="2413.875" y2="2413.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2409.0186">[048]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="815" y="2409.0186"/><polygon fill="#FF0000" points="1448.5,2409.875,1458.5,2413.875,1448.5,2417.875,1452.5,2413.875" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="771" x2="1454.5" y1="2413.875" y2="2413.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="778" y="2409.0186">[049]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="815" y="2409.0186"/><polygon fill="#FF0000" points="427,2440.2266,417,2444.2266,427,2448.2266,423,2444.2266" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="421" x2="760" y1="2444.2266" y2="2444.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="433" y="2439.3701">[050]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="466" y="2439.3701">done</text><path d="M1370,2471.2266 L1370,2530.2266 L1569,2530.2266 L1569,2481.2266 L1559,2471.2266 L1370,2471.2266 " fill="#FBFB77" filter="url(#f1axfy42rpaf5u)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1559,2471.2266 L1559,2481.2266 L1569,2481.2266 L1559,2471.2266 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="1376" y="2489.7217">Did not purge temp memory</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="1376" y="2506.0732">as it contains encrypted object</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="32" x="1376" y="2522.4248">purge</text><polygon fill="#FF0000" points="234,2573.9844,224,2577.9844,234,2581.9844,230,2577.9844" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="228" x2="405" y1="2577.9844" y2="2577.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="240" y="2564.9521">[051]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="273" y="2556.7764">Command response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="273" y="2573.1279">new_encrypted_pmek</text><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="73" y1="2577.9844" y2="2573.9844"/><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="73" y1="2577.9844" y2="2581.9844"/><line style="stroke:#008000;stroke-width:1.0;" x1="63" x2="222" y1="2577.9844" y2="2577.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="80" y="2564.9521">[052]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="113" y="2556.7764">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="113" y="2573.1279">complete</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="134" x="783" y="2688.1934">Filename: rewrap_pmek.uml</text><!--MD5=[5f51ea903d0c85d5e2c18507b7f3cd12]
@startuml

!include ocp_lock_utils.inc

!if ($show_title)
    Title "Rewrap PMEK"
!endif

!if ($show_precond)
    note across
        <b>Preconditions:</b>
        * Access Shared Secret already availble in a slot in KV
        * unlocking key already in a slot and generated on each reset
    end note
!endif

srk++ $BUFFER_ACTIVATION
kemg++ $BUFFER_ACTIVATION


fw $async mb++ : REWRAP_PMEK

!if ($show_api)
    note right mb
        | <b>Field                 | <b>Size                | <b>Definition |
        | chksum                   | u32                    | Little endian |
        | wrapped_access_key_1     | WrappedAccessKey       | KEM-wrapped access key\n   * access_key_algorithm\n   * kem_handle (X)\n   * kem_algorithm\n   * kem_ciphertext\n   * encrypted_access_key |
        | wrapped_enc_access_key_2 | DoubleWrappedAccessKey | KEM-wrapped (access_key_2 encrypted to access_key_1)\n   * double_encrypted_access_key |
        | old_locked_pmek          | EncryptedPmek          | PMEK encrypted to access_key_1 |
    end note
!endif

mb $async cfw++ : Command

!if ($show_msg_parsing)
    cfw $sync mb : Get command
    mb- -
    $self("cfw", "Determine command")
!else
    mb- -
!endif

alt Storage Root Key exists

    == Get Access Key 1 ==
    cfw $sync kv++: Decaps(KEM Pair : kem_handle (g),\n            KEM ciphertext : kem_ciphertext from\n                                      wrapped_access_key_1\n            Destination : Slot Y)
    kv $sync kemg: Get KEM Keypair
    kv $sync kv: Decap KEM Ciphertext\nwith Keypair
    kv $sync tempy: Put Shared Secret
    tempy++ $BUFFER_ACTIVATION
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif


    cfw $sync kv++: Unwrap(Key : Slot Y\n            Key Data : wrapped_access_key_1,\n            Destination : Slot Z)
    kv $sync tempy: Get Shared Secret
    kv $sync kv: Unwrap\nwrapped_access_key_1
    kv $sync tempz: Put Access Key 1
    tempz++ $BUFFER_ACTIVATION
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif

    == Get Access Key 2 ==
    cfw $sync kv++: Unwrap(Key : Slot Y,\n            Key Data: double_encrypted_access_key,\n            Destination Memory: <font color=red>Put in memory\n                                           <font color=red>as not a key)
    kv $sync tempy: Get Shared Secret
    kv $sync kv: Unwrap\ndouble_encrypted_access_key\nwith Slot Y
    kv $sync tempmem: Encrypted Access Key 2
'    note left
'      <font color=red>We are encrypting the access key 2 twice, first
'      <font color=red>with the access key 1 and then second with the
'      <font color=red>shared secret. If we limit our access key encryption
'      <font color=red>algorihtm to AEAD, such as AES-GCM, we can replace
'      <font color=red>it by a single encryption with the shared secret as
'      <font color=red>key and the access key 1 as associated data.
'    end note
    tempmem++ $BUFFER_ACTIVATION
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif

    cfw $sync kv++: Unwrap(Key : Slot Z\n            Key Data : Temp Memory,\n            Destination : Slot Y)
    kv $sync tempz: Get Access Key 1
    kv $sync tempmem: Get encrypted_access_key
    kv $sync kv: Unwrap encrypted access key 2
    kv $sync tempy: Put Access Key 2
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif


    == Create PMEK wrapping/unwrapping Keys ==
    cfw $sync kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Z\n                         Destination : Slot W)
    kv $sync srk: Get Storage Root Key
    kv $sync tempz: Get Access Key 1
    kv $sync kv: HMAC512 slot A and Slot Z
    kv $sync tempw: HMAC512 result Encryption Key for old PMEK
    tempw++ $BUFFER_ACTIVATION
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif

    cfw $sync kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Y\n                         Destination : Slot Z)
    kv $sync srk: Get System Root Key
    kv $sync tempy: Get Access Key 2
    kv $sync kv: HMAC512 slot A and Slot Y
    kv $sync tempz: HMAC512 result New Encryption Key for PMEK
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif

    == Get PMEK ==
    cfw $sync kv++: Unwrap(Key : Slot W,\n            Key Data: locked_pmek\n            Destination : Slot Y)
    kv $sync tempw: Encryption Key for old PMEK
    kv $sync kv: Unwrap locked_pmek
    kv $sync tempy: PMEK
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif


    == Create the locked PMEK ==
    cfw $sync kv++: Wrap(Key: Slot Z,\n             Data Key : Slot Y\n             Destination : new_locked_pmek)
    kv $sync tempz: Get New Encryption Key
    kv $sync tempy: Get PMEK
    kv $sync kv: Wrap slot Y with Slot Z to\ngenerate new_encrypted_pmek
    !if ($show_done)
        kv $sync cfw- - : new_encrypted_pmek
    !else
        kv- -
    !endif

    cfw $sync kv++: Purge_key(Key: Slot W,\n                Key : Slot Y,\n                Key : Slot Z)
    kv $sync tempw !! : Purge
    & kv $sync tempy !!
    & kv $sync tempz !!
    !if ($show_done)
        kv $sync cfw- - : done
    !else
        kv- -
    !endif
end

note left tempmem
    <font color=red>Did not purge temp memory
    <font color=red>as it contains encrypted object
    purge
end note


cfw $sync mb : Command response\nnew_encrypted_pmek
& mb $async fw++ : Command\ncomplete

!if ($show_api)
    note right mb
        | <b>Field           | <b>Size       | <b>Definition |
        | chksum             | u32           | Little endian |
        | fips_status        | u32           | Indicates if the command is FIPS approved or an error |
        | new_encrypted_pmek | EncryptedPmek | PMEK encrypted to access_key_2 |
    end note
!endif
cfw- -

@enduml

@startuml









	autonumber 1 1  "<b>[000]"

	!pragma teoz true

    participant "Remote Key\nManagement Service" as rkms


    participant "Host" as host


    participant "Storage\nDevice\nFW" as fw

    box "Caliptra"
    	participant "Mail Box" as mb
    	participant "ROM" as crom
    	participant "FW" as cfw
    	participant "ROM to FW\nHandoff Data" as hoff
        participant "DRBG" as rand
        participant "DMA Engine" as dma
        participant "Key Vault" as kv
        participant "Key Vault\nFuses" as fuses
        participant "Key Vault\nStorage Root Key" as gsrk
        participant "Key Vault\nSlot A\n(Storage Root Key)" as srk
        participant "Key Vault\nSlot B\n(PMEK Secret)" as pmeks
        participant "Key Vault\nSlot F\n(DICE Alias Key)\necdsa_secp384r1_sha384" as dice
        participant "Key Vault\nSlot G\n(KEM Keypair)" as kemg
        participant "Key Vault\nSlot W\n(Temporary)" as tempw
        participant "Key Vault\nSlot X\n(MEK Seed)" as meks
        participant "Key Vault\nSlot Y\n(Temporary)" as tempy
        participant "Key Vault\nSlot Z\n(Temporary)" as tempz
        participant "Key Vault\nTemp Memory" as tempmem
    end box

    box "Encryption Engine"
        participant "SFR\nInterface" as sfr
        participant "Control" as ee
        participant "Key Cache" as kc
    end box

    box "Media"
        participant "Create new\Storage Root Key\non NVM subsystem reset" as csrk
        participant "Destroy all\Storage Root Keys\non NVM subsystem reset" as dsrk
    end box

    hide unlinked
	footer Filename: rewrap_pmek.uml

	header Version 1


    Title "Rewrap PMEK"

    note across
        <b>Preconditions:</b>
        * Access Shared Secret already availble in a slot in KV
        * unlocking key already in a slot and generated on each reset
    end note

srk++ #lightblue
kemg++ #lightblue


fw -[#green]>> mb++ : REWRAP_PMEK


mb -[#green]>> cfw++ : Command

    mb- -

alt Storage Root Key exists

    == Get Access Key 1 ==
    cfw -[#red]> kv++: Decaps(KEM Pair : kem_handle (g),\n            KEM ciphertext : kem_ciphertext from\n                                      wrapped_access_key_1\n            Destination : Slot Y)
    kv -[#red]> kemg: Get KEM Keypair
    kv -[#red]> kv: Decap KEM Ciphertext\nwith Keypair
    kv -[#red]> tempy: Put Shared Secret
    tempy++ #lightblue
        kv -[#red]> cfw- - : done


    cfw -[#red]> kv++: Unwrap(Key : Slot Y\n            Key Data : wrapped_access_key_1,\n            Destination : Slot Z)
    kv -[#red]> tempy: Get Shared Secret
    kv -[#red]> kv: Unwrap\nwrapped_access_key_1
    kv -[#red]> tempz: Put Access Key 1
    tempz++ #lightblue
        kv -[#red]> cfw- - : done

    == Get Access Key 2 ==
    cfw -[#red]> kv++: Unwrap(Key : Slot Y,\n            Key Data: double_encrypted_access_key,\n            Destination Memory: <font color=red>Put in memory\n                                           <font color=red>as not a key)
    kv -[#red]> tempy: Get Shared Secret
    kv -[#red]> kv: Unwrap\ndouble_encrypted_access_key\nwith Slot Y
    kv -[#red]> tempmem: Encrypted Access Key 2
    tempmem++ #lightblue
        kv -[#red]> cfw- - : done

    cfw -[#red]> kv++: Unwrap(Key : Slot Z\n            Key Data : Temp Memory,\n            Destination : Slot Y)
    kv -[#red]> tempz: Get Access Key 1
    kv -[#red]> tempmem: Get encrypted_access_key
    kv -[#red]> kv: Unwrap encrypted access key 2
    kv -[#red]> tempy: Put Access Key 2
        kv -[#red]> cfw- - : done


    == Create PMEK wrapping/unwrapping Keys ==
    cfw -[#red]> kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Z\n                         Destination : Slot W)
    kv -[#red]> srk: Get Storage Root Key
    kv -[#red]> tempz: Get Access Key 1
    kv -[#red]> kv: HMAC512 slot A and Slot Z
    kv -[#red]> tempw: HMAC512 result Encryption Key for old PMEK
    tempw++ #lightblue
        kv -[#red]> cfw- - : done

    cfw -[#red]> kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Y\n                         Destination : Slot Z)
    kv -[#red]> srk: Get System Root Key
    kv -[#red]> tempy: Get Access Key 2
    kv -[#red]> kv: HMAC512 slot A and Slot Y
    kv -[#red]> tempz: HMAC512 result New Encryption Key for PMEK
        kv -[#red]> cfw- - : done

    == Get PMEK ==
    cfw -[#red]> kv++: Unwrap(Key : Slot W,\n            Key Data: locked_pmek\n            Destination : Slot Y)
    kv -[#red]> tempw: Encryption Key for old PMEK
    kv -[#red]> kv: Unwrap locked_pmek
    kv -[#red]> tempy: PMEK
        kv -[#red]> cfw- - : done


    == Create the locked PMEK ==
    cfw -[#red]> kv++: Wrap(Key: Slot Z,\n             Data Key : Slot Y\n             Destination : new_locked_pmek)
    kv -[#red]> tempz: Get New Encryption Key
    kv -[#red]> tempy: Get PMEK
    kv -[#red]> kv: Wrap slot Y with Slot Z to\ngenerate new_encrypted_pmek
        kv -[#red]> cfw- - : new_encrypted_pmek

    cfw -[#red]> kv++: Purge_key(Key: Slot W,\n                Key : Slot Y,\n                Key : Slot Z)
    kv -[#red]> tempw !! : Purge
    & kv -[#red]> tempy !!
    & kv -[#red]> tempz !!
        kv -[#red]> cfw- - : done
end

note left tempmem
    <font color=red>Did not purge temp memory
    <font color=red>as it contains encrypted object
    purge
end note


cfw -[#red]> mb : Command response\nnew_encrypted_pmek
& mb -[#green]>> fw++ : Command\ncomplete

cfw- -

@enduml

PlantUML version 1.2021.7(Sun May 23 06:40:07 MDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>