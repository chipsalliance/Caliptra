<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="1140px" preserveAspectRatio="none" style="width:1406px;height:1140px;background:#FFFFFF;" version="1.1" viewBox="0 0 1406 1140" width="1406px" zoomAndPan="magnify"><defs><filter height="300%" id="f10mij2375f10j" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="1062.7734" style="stroke:#A80036;stroke-width:1.0;" width="957" x="361.75" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="815.25" y="68.7139">Caliptra</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="44" x="1355.75" y="15.3809">Version 1</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="258" x="599.75" y="43.2637">Endorse Encapsulation Pub Key</text><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="526.625" style="stroke:#000000;stroke-width:2.0;" width="935.5" x="365.75" y="425.2266"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="149.7578" style="stroke:#000000;stroke-width:2.0;" width="891.5" x="384.75" y="457.5781"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="312.5156" style="stroke:#000000;stroke-width:2.0;" width="734" x="384.75" y="625.3359"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="91.75" x2="91.75" y1="165.0078" y2="1022.5547"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="18" style="stroke:#A80036;stroke-width:1.0;" width="10" x="86.75" y="1004.5547"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="400.75" x2="400.75" y1="165.0078" y2="1022.5547"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="43.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="395.75" y="382.875"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="578.75" x2="578.75" y1="165.0078" y2="1022.5547"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="604.3281" style="stroke:#A80036;stroke-width:1.0;" width="10" x="573.75" y="413.2266"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="925.75" x2="925.75" y1="165.0078" y2="1022.5547"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="60.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="920.75" y="508.2813"/><rect fill="#FFFFFF" filter="url(#f10mij2375f10j)" height="104.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="920.75" y="752.0938"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1102.75" x2="1102.75" y1="165.0078" y2="1022.5547"/><rect fill="#ADD8E6" filter="url(#f10mij2375f10j)" height="662.0313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1097.75" y="360.5234"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1260.25" x2="1260.25" y1="165.0078" y2="1022.5547"/><rect fill="#ADD8E6" filter="url(#f10mij2375f10j)" height="662.0313" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1255.25" y="360.5234"/><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="57.75" y="93.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="64.75" y="114.7129">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="68.25" y="132.3223">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="78.75" y="149.9316">FW</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="365.75" y="128.3984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="372.75" y="149.9316">Mail Box</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="558.75" y="128.3984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="565.75" y="149.9316">FW</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="886.75" y="128.3984"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="893.75" y="149.9316">Key Vault</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="84.4375" style="stroke:#A80036;stroke-width:1.5;" width="182" x="1009.75" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1070.75" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1082.25" y="114.7129">Slot F</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="1048.75" y="132.3223">(DICE Alias Key)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="1016.75" y="149.9316">ecdsa_secp384r1_sha384</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1205.75" y="93.1797"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1228.25" y="114.7129">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1238.75" y="132.3223">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1212.75" y="149.9316">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="57.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="64.75" y="1044.0879">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="68.25" y="1061.6973">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="78.75" y="1079.3066">FW</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="365.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="372.75" y="1044.0879">Mail Box</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="558.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="565.75" y="1044.0879">FW</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="886.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="893.75" y="1044.0879">Key Vault</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="84.4375" style="stroke:#A80036;stroke-width:1.5;" width="182" x="1009.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1070.75" y="1044.0879">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1082.25" y="1061.6973">Slot F</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="104" x="1048.75" y="1079.3066">(DICE Alias Key)</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="168" x="1016.75" y="1096.916">ecdsa_secp384r1_sha384</text><rect fill="#FEFECE" filter="url(#f10mij2375f10j)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1205.75" y="1022.5547"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1228.25" y="1044.0879">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1238.75" y="1061.6973">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1212.75" y="1079.3066">(KEM Keypair)</text><path d="M10,178.0078 L10,351.0078 L1338,351.0078 L1338,188.0078 L1328,178.0078 L10,178.0078 " fill="#FBFB77" filter="url(#f10mij2375f10j)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1328,178.0078 L1328,188.0078 L1338,188.0078 L1328,178.0078 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91" x="16" y="196.5029">Preconditions:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="403" x="24" y="212.8545">* DICE Alias Key is available in a KV slot and FW manages the slot #</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="427" x="32" y="229.2061">The DICE Alias Key in already defined by Caliptra and is not the DPE Key</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="376" x="24" y="245.5576">* KEM Keypair available in a KV slot and FW manages the slot #</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="20" y="261.9092"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="39" x="16" y="278.2607">Notes:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="1299" x="24" y="294.6123">* The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="535" x="24" y="310.9639">* This sequence is focused on successful execution of operations by the KV. Sill need to do:</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="20" y="327.3154"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="28" y="343.667"/><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="32" y="343.667">Need to add more algorithms</text><line style="stroke:#008000;stroke-width:1.0;" x1="393.75" x2="383.75" y1="382.875" y2="378.875"/><line style="stroke:#008000;stroke-width:1.0;" x1="393.75" x2="383.75" y1="382.875" y2="386.875"/><line style="stroke:#008000;stroke-width:1.0;" x1="91.75" x2="394.75" y1="382.875" y2="382.875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="98.75" y="378.0186">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="131.75" y="378.0186">ENDORSE_ENCAPSULATION_PUB_KEY</text><line style="stroke:#008000;stroke-width:1.0;" x1="571.75" x2="561.75" y1="413.2266" y2="409.2266"/><line style="stroke:#008000;stroke-width:1.0;" x1="571.75" x2="561.75" y1="413.2266" y2="417.2266"/><line style="stroke:#008000;stroke-width:1.0;" x1="405.75" x2="572.75" y1="413.2266" y2="413.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="412.75" y="408.3701">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="445.75" y="408.3701">Command</text><path d="M365.75,425.2266 L426.75,425.2266 L426.75,433.2266 L416.75,443.2266 L365.75,443.2266 L365.75,425.2266 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="526.625" style="stroke:#000000;stroke-width:2.0;" width="935.5" x="365.75" y="425.2266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="380.75" y="439.7217">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="240" x="441.75" y="438.6455">[kem_handle (G) has a Key Pair in KV slot G]</text><path d="M384.75,457.5781 L445.75,457.5781 L445.75,465.5781 L435.75,475.5781 L384.75,475.5781 L384.75,457.5781 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="149.7578" style="stroke:#000000;stroke-width:2.0;" width="891.5" x="384.75" y="457.5781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="399.75" y="472.0732">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="122" x="460.75" y="470.9971">[Slot X algorithm type]</text><polygon fill="#FF0000" points="908.75,504.2813,918.75,508.2813,908.75,512.2813,912.75,508.2813" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="583.75" x2="914.75" y1="508.2813" y2="508.2813"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="590.75" y="503.4248">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="229" x="623.75" y="503.4248">Get_Pub_ecdh_secp384r1(Key: Slot G)</text><polygon fill="#FF0000" points="1243.25,534.6328,1253.25,538.6328,1243.25,542.6328,1247.25,538.6328" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="930.75" x2="1249.25" y1="538.6328" y2="538.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="937.75" y="533.7764">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="88" x="970.75" y="533.7764">Get Public Key</text><polygon fill="#FF0000" points="594.75,564.9844,584.75,568.9844,594.75,572.9844,590.75,568.9844" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="588.75" x2="919.75" y1="568.9844" y2="568.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="600.75" y="564.1279">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="633.75" y="564.1279">pub_key</text><polygon fill="#FF0000" points="411.75,595.3359,401.75,599.3359,411.75,603.3359,407.75,599.3359" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="405.75" x2="572.75" y1="599.3359" y2="599.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="417.75" y="594.4795">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="49" x="450.75" y="594.4795">pub_key</text><path d="M384.75,625.3359 L445.75,625.3359 L445.75,633.3359 L435.75,643.3359 L384.75,643.3359 L384.75,625.3359 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="312.5156" style="stroke:#000000;stroke-width:2.0;" width="734" x="384.75" y="625.3359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="399.75" y="639.8311">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="223" x="460.75" y="638.7549">[endorsement algorithm Byte 0 bit 0 set]</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="583.75" x2="625.75" y1="676.0391" y2="676.0391"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="625.75" x2="625.75" y1="676.0391" y2="689.0391"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="584.75" x2="625.75" y1="689.0391" y2="689.0391"/><polygon fill="#FF0000" points="594.75,685.0391,584.75,689.0391,594.75,693.0391,590.75,689.0391" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="590.75" y="671.1826">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="140" x="623.75" y="671.1826">Build the certificate TBS</text><polygon fill="#FF0000" points="908.75,748.0938,918.75,752.0938,908.75,756.0938,912.75,752.0938" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="583.75" x2="914.75" y1="752.0938" y2="752.0938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="590.75" y="730.8857">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="225" x="623.75" y="714.5342">ecdsa_secp384r1_sha384(Key: Slot F,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="779.75" y="730.8857">Data : certificate TBS</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="104" x="779.75" y="747.2373">Output: signature)</text><polygon fill="#FF0000" points="1085.75,778.4453,1095.75,782.4453,1085.75,786.4453,1089.75,782.4453" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="930.75" x2="1091.75" y1="782.4453" y2="782.4453"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="937.75" y="777.5889">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="970.75" y="777.5889">Get DICE Alias Key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="930.75" x2="972.75" y1="812.7969" y2="812.7969"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="972.75" x2="972.75" y1="812.7969" y2="825.7969"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="931.75" x2="972.75" y1="825.7969" y2="825.7969"/><polygon fill="#FF0000" points="941.75,821.7969,931.75,825.7969,941.75,829.7969,937.75,825.7969" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="937.75" y="807.9404">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="107" x="970.75" y="807.9404">generate signature</text><polygon fill="#FF0000" points="594.75,852.1484,584.75,856.1484,594.75,860.1484,590.75,856.1484" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="588.75" x2="919.75" y1="856.1484" y2="856.1484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="600.75" y="851.292">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="633.75" y="851.292">signature</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="583.75" x2="625.75" y1="886.5" y2="886.5"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="625.75" x2="625.75" y1="886.5" y2="899.5"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="584.75" x2="625.75" y1="899.5" y2="899.5"/><polygon fill="#FF0000" points="594.75,895.5,584.75,899.5,594.75,903.5,590.75,899.5" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="590.75" y="881.6436">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="295" x="623.75" y="881.6436">Append signature to certificate To Be Signed (TBS)</text><polygon fill="#FF0000" points="411.75,925.8516,401.75,929.8516,411.75,933.8516,407.75,929.8516" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="405.75" x2="572.75" y1="929.8516" y2="929.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="417.75" y="924.9951">[013]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="450.75" y="924.9951">signed_certificate</text><polygon fill="#FF0000" points="411.75,1000.5547,401.75,1004.5547,411.75,1008.5547,407.75,1004.5547" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="405.75" x2="572.75" y1="1004.5547" y2="1004.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="417.75" y="999.6982">[014]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="450.75" y="999.6982">Command response</text><line style="stroke:#008000;stroke-width:1.0;" x1="96.75" x2="106.75" y1="1004.5547" y2="1000.5547"/><line style="stroke:#008000;stroke-width:1.0;" x1="96.75" x2="106.75" y1="1004.5547" y2="1008.5547"/><line style="stroke:#008000;stroke-width:1.0;" x1="96.75" x2="399.75" y1="1004.5547" y2="1004.5547"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="113.75" y="991.5225">[015]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="146.75" y="983.3467">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="146.75" y="999.6982">complete</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="227" x="615.25" y="1132.373">Filename: endorse_encapsulation_pub_key.uml</text><!--MD5=[4ba4d46de5c65791164f7034460279f6]
@startuml

!include ocp_lock_utils.inc

!if ($show_title)
    Title "Endorse Encapsulation Pub Key"
!endif

!if ($show_precond)
    note across
        <b>Preconditions:</b>
          * DICE Alias Key is available in a KV slot and FW manages the slot #
            The DICE Alias Key in already defined by Caliptra and is not the DPE Key
          * KEM Keypair available in a KV slot and FW manages the slot #

        <b>Notes:</b>
          * The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.
          * This sequence is focused on successful execution of operations by the KV. Sill need to do:

           <font color=red> Need to add more algorithms
    end note
!endif

' Pre-existing state
dice++ $BUFFER_ACTIVATION
kemg++ $BUFFER_ACTIVATION


fw $async mb++ : ENDORSE_ENCAPSULATION_PUB_KEY

!if ($show_api)
    note right mb
        | <b>Field             | <b>Size | <b>Definition |
        | chksum                | u32    | Little endian |
        | kem_handle            | u32    | Handle for KEM keypair held in KMB memory|
        | endorsement_algorithm | u32    | Endorsement algorithm identifier\n * If 0h, then return public key |
    end note
!endif

mb $async cfw++ : Command

!if ($show_msg_parsing)
    cfw $sync mb : Get command
    mb- -
    $self("cfw", "Determine command")
!else
    mb- -
!endif

alt kem_handle (G) has a Key Pair in KV slot G

    alt Slot X algorithm type

        cfw $sync kv++: Get_Pub_ecdh_secp384r1(Key: Slot G)
        kv $sync kemg: Get Public Key
        !if ($show_done)
            kv $sync cfw- - : pub_key
        !else
            kv- -
        !endif
        cfw $sync mb : pub_key
    end

    alt endorsement algorithm Byte 0 bit 0 set

        cfw $sync cfw: Build the certificate TBS

        cfw $sync kv++: ecdsa_secp384r1_sha384(Key: Slot F,\n                                       Data : certificate TBS\n                                       Output: signature)
        kv $sync dice : Get DICE Alias Key
        kv $sync kv: generate signature
        !if ($show_done)
            kv $sync cfw- - : signature
        !else
            kv- -
        !endif
        cfw $sync cfw: Append signature to certificate To Be Signed (TBS)
        cfw $sync mb : signed_certificate
    end
end


cfw $sync mb : Command response
& mb $async fw++ : Command\ncomplete

!if ($show_api)
    note right mb
        | <b>Field        | <b>Size   | <b>Definition |
        | chksum          | u32       | Little endian |
        | fips_status     | u32       | Indicates if the command is FIPS approved or an error |
        | pub_key         | KemPubKey | KEM public key |
        | endorsement_len | u32       | Length of endorsement data (N) |
        | endorsement     | u8[N]     | DER-encoded X.509 certificate (includes nonce as extension) |
    end note
!endif
cfw- -

@enduml

@startuml









	autonumber 1 1  "<b>[000]"

	!pragma teoz true

    participant "Remote Key\nManagement Service" as rkms


    participant "Host" as host


    participant "Storage\nDevice\nFW" as fw

    box "Caliptra"
    	participant "Mail Box" as mb
    	participant "ROM" as crom
    	participant "FW" as cfw
    	participant "ROM to FW\nHandoff Data" as hoff
        participant "DRBG" as rand
        participant "DMA Engine" as dma
        participant "Key Vault" as kv
        participant "Key Vault\nFuses" as fuses
        participant "Key Vault\nStorage Root Key" as gsrk
        participant "Key Vault\nSlot A\n(Storage Root Key)" as srk
        participant "Key Vault\nSlot B\n(PMEK Secret)" as pmeks
        participant "Key Vault\nSlot F\n(DICE Alias Key)\necdsa_secp384r1_sha384" as dice
        participant "Key Vault\nSlot G\n(KEM Keypair)" as kemg
        participant "Key Vault\nSlot W\n(Temporary)" as tempw
        participant "Key Vault\nSlot X\n(MEK Seed)" as meks
        participant "Key Vault\nSlot Y\n(Temporary)" as tempy
        participant "Key Vault\nSlot Z\n(Temporary)" as tempz
        participant "Key Vault\nTemp Memory" as tempmem
    end box

    box "Encryption Engine"
        participant "SFR\nInterface" as sfr
        participant "Control" as ee
        participant "Key Cache" as kc
    end box

    box "Media"
        participant "Create new\Storage Root Key\non NVM subsystem reset" as csrk
        participant "Destroy all\Storage Root Keys\non NVM subsystem reset" as dsrk
    end box

    hide unlinked
	footer Filename: endorse_encapsulation_pub_key.uml

	header Version 1


    Title "Endorse Encapsulation Pub Key"

    note across
        <b>Preconditions:</b>
          * DICE Alias Key is available in a KV slot and FW manages the slot #
            The DICE Alias Key in already defined by Caliptra and is not the DPE Key
          * KEM Keypair available in a KV slot and FW manages the slot #

        <b>Notes:</b>
          * The sequence diagram assumes that the KV will not allow an input KV slot to also be used as an out KV slot. Caliptra FW is responsible for managing which KV slots are used and can adapt if this assumption is not correct.
          * This sequence is focused on successful execution of operations by the KV. Sill need to do:

           <font color=red> Need to add more algorithms
    end note

dice++ #lightblue
kemg++ #lightblue


fw -[#green]>> mb++ : ENDORSE_ENCAPSULATION_PUB_KEY


mb -[#green]>> cfw++ : Command

    mb- -

alt kem_handle (G) has a Key Pair in KV slot G

    alt Slot X algorithm type

        cfw -[#red]> kv++: Get_Pub_ecdh_secp384r1(Key: Slot G)
        kv -[#red]> kemg: Get Public Key
            kv -[#red]> cfw- - : pub_key
        cfw -[#red]> mb : pub_key
    end

    alt endorsement algorithm Byte 0 bit 0 set

        cfw -[#red]> cfw: Build the certificate TBS

        cfw -[#red]> kv++: ecdsa_secp384r1_sha384(Key: Slot F,\n                                       Data : certificate TBS\n                                       Output: signature)
        kv -[#red]> dice : Get DICE Alias Key
        kv -[#red]> kv: generate signature
            kv -[#red]> cfw- - : signature
        cfw -[#red]> cfw: Append signature to certificate To Be Signed (TBS)
        cfw -[#red]> mb : signed_certificate
    end
end


cfw -[#red]> mb : Command response
& mb -[#green]>> fw++ : Command\ncomplete

cfw- -

@enduml

PlantUML version 1.2021.7(Sun May 23 06:40:07 MDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>