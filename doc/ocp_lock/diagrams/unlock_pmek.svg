<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="4178px" preserveAspectRatio="none" style="width:1938px;height:4178px;background:#FFFFFF;" version="1.1" viewBox="0 0 1938 4178" width="1938px" zoomAndPan="magnify"><defs><filter height="300%" id="fg2o76874rb9g" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#DDDDDD" height="4100.7656" style="stroke:#A80036;stroke-width:1.0;" width="1586" x="217" y="55.2188"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="50" x="985" y="68.7139">Caliptra</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="44" x="1887" y="15.3809">Version 1</text><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="111" x="941" y="43.2637">Unlock PMEK</text><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="3701.2969" style="stroke:#000000;stroke-width:2.0;" width="1857" x="8" y="352.8594"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="3654.9453" style="stroke:#000000;stroke-width:2.0;" width="1813" x="27" y="385.2109"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="933.25" style="stroke:#000000;stroke-width:2.0;" width="1662" x="46" y="461.9141"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="1703.0938" style="stroke:#000000;stroke-width:2.0;" width="1769" x="46" y="1413.1641"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="96" x2="96" y1="147.3984" y2="4078.1563"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="46" style="stroke:#A80036;stroke-width:1.0;" width="10" x="91" y="4032.1563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="256" x2="256" y1="147.3984" y2="4078.1563"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="43.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="251" y="267.1563"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="434" x2="434" y1="147.3984" y2="4078.1563"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="3775.6484" style="stroke:#A80036;stroke-width:1.0;" width="10" x="429" y="297.5078"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1016" x2="1016" y1="147.3984" y2="4078.1563"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="545.3203"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="710.0781"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="104.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="1008.5938"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="1252.7578"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="104.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="1597.625"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="104.0547" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="1825.4375"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="2053.25"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="174.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="2327.7656"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="174.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="2642.6328"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="2973.8516"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="164.7578" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="3229.6641"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="3501.8281"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="134.4063" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="3743.6406"/><rect fill="#FFFFFF" filter="url(#fg2o76874rb9g)" height="60.7031" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1011" y="3924.75"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1275" x2="1275" y1="147.3984" y2="4078.1563"/><rect fill="#ADD8E6" filter="url(#fg2o76874rb9g)" height="3833.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1270" y="244.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1410.5" x2="1410.5" y1="147.3984" y2="4078.1563"/><rect fill="#ADD8E6" filter="url(#fg2o76874rb9g)" height="3833.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1405.5" y="244.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1530.5" x2="1530.5" y1="147.3984" y2="4078.1563"/><rect fill="#ADD8E6" filter="url(#fg2o76874rb9g)" height="3833.3516" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1525.5" y="244.8047"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1643.5" x2="1643.5" y1="147.3984" y2="4078.1563"/><rect fill="#ADD8E6" filter="url(#fg2o76874rb9g)" height="2872.8047" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1638.5" y="1082.2969"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1634.5" x2="1652.5" y1="3946.1016" y2="3964.1016"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1634.5" x2="1652.5" y1="3964.1016" y2="3946.1016"/><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="1750.5" x2="1750.5" y1="147.3984" y2="4078.1563"/><rect fill="#ADD8E6" filter="url(#fg2o76874rb9g)" height="877.1953" style="stroke:#A80036;stroke-width:1.0;" width="10" x="1745.5" y="3077.9063"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1741.5" x2="1759.5" y1="3946.1016" y2="3964.1016"/><line style="stroke:#A80036;stroke-width:2.0;" x1="1741.5" x2="1759.5" y1="3964.1016" y2="3946.1016"/><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="62" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="69" y="97.1035">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="72.5" y="114.7129">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="83" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="221" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="228" y="132.3223">Mail Box</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="414" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="421" y="132.3223">FW</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="977" y="110.7891"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="984" y="132.3223">Key Vault</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="1205" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1243" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1254.5" y="114.7129">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="1212" y="132.3223">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="107" x="1355" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1378.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1390" y="114.7129">Slot B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="1362" y="132.3223">(PMEK Secret)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1476" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1498.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1509" y="114.7129">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1483" y="132.3223">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1595" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1611.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1623" y="114.7129">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1602" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1702" y="75.5703"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1718.5" y="97.1035">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1730.5" y="114.7129">Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1709" y="132.3223">(Temporary)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="64" x="62" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="50" x="69" y="4099.6895">Storage</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="43" x="72.5" y="4117.2988">Device</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="83" y="4134.9082">FW</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="66" x="221" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="52" x="228" y="4099.6895">Mail Box</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="36" x="414" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="22" x="421" y="4099.6895">FW</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="74" x="977" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="984" y="4099.6895">Key Vault</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="136" x="1205" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1243" y="4099.6895">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1254.5" y="4117.2988">Slot A</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="1212" y="4134.9082">(Storage Root Key)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="107" x="1355" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1378.5" y="4099.6895">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1390" y="4117.2988">Slot B</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="93" x="1362" y="4134.9082">(PMEK Secret)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="105" x="1476" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1498.5" y="4099.6895">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="39" x="1509" y="4117.2988">Slot G</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="1483" y="4134.9082">(KEM Keypair)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1595" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1611.5" y="4099.6895">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="37" x="1623" y="4117.2988">Slot Y</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1602" y="4134.9082">(Temporary)</text><rect fill="#FEFECE" filter="url(#fg2o76874rb9g)" height="66.8281" style="stroke:#A80036;stroke-width:1.5;" width="93" x="1702" y="4078.1563"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="60" x="1718.5" y="4099.6895">Key Vault</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="36" x="1730.5" y="4117.2988">Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="79" x="1709" y="4134.9082">(Temporary)</text><path d="M59.75,160.3984 L59.75,235.3984 L1786.75,235.3984 L1786.75,170.3984 L1776.75,160.3984 L59.75,160.3984 " fill="#FBFB77" filter="url(#fg2o76874rb9g)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1776.75,160.3984 L1776.75,170.3984 L1786.75,170.3984 L1776.75,160.3984 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="91" x="737.75" y="178.8936">Preconditions:</text><ellipse cx="743.25" cy="190.6016" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="309" x="750.75" y="195.2451">Access Shared Secret already availble in a slot in KV</text><ellipse cx="743.25" cy="206.9531" fill="#000000" rx="2.5" ry="2.5" style="stroke:#000000;stroke-width:0.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="345" x="750.75" y="211.5967">unlocking key already in a slot and generated on each reset</text><text fill="#FF0000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="737.75" y="227.9482">Is there a separate Shared Secret per Admin User?</text><line style="stroke:#008000;stroke-width:1.0;" x1="249" x2="239" y1="267.1563" y2="263.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="249" x2="239" y1="267.1563" y2="271.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="96" x2="250" y1="267.1563" y2="267.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="103" y="262.2998">[001]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="136" y="262.2998">UNLOCK_PMEK</text><line style="stroke:#008000;stroke-width:1.0;" x1="427" x2="417" y1="297.5078" y2="293.5078"/><line style="stroke:#008000;stroke-width:1.0;" x1="427" x2="417" y1="297.5078" y2="301.5078"/><line style="stroke:#008000;stroke-width:1.0;" x1="261" x2="428" y1="297.5078" y2="297.5078"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="268" y="292.6514">[002]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="301" y="292.6514">Command</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="481" y1="327.8594" y2="327.8594"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="481" x2="481" y1="327.8594" y2="340.8594"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="440" x2="481" y1="340.8594" y2="340.8594"/><polygon fill="#FF0000" points="450,336.8594,440,340.8594,450,344.8594,446,340.8594" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="323.0029">[003]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="158" x="479" y="323.0029">Determine rate of unlocking</text><path d="M8,352.8594 L69,352.8594 L69,360.8594 L59,370.8594 L8,370.8594 L8,352.8594 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="3701.2969" style="stroke:#000000;stroke-width:2.0;" width="1857" x="8" y="352.8594"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="23" y="367.3545">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="139" x="84" y="366.2783">[Storage Root Key exists]</text><path d="M27,385.2109 L88,385.2109 L88,393.2109 L78,403.2109 L27,403.2109 L27,385.2109 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="3654.9453" style="stroke:#000000;stroke-width:2.0;" width="1813" x="27" y="385.2109"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="42" y="399.7061">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="181" x="103" y="398.6299">[Unlocking rate below threshold]</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="434.7383"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="434.7383" y2="434.7383"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="437.7383" y2="437.7383"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="139" x="870" y="423.5625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="121" x="876" y="441.0576">Get the Access Key</text><path d="M46,461.9141 L107,461.9141 L107,469.9141 L97,479.9141 L46,479.9141 L46,461.9141 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="933.25" style="stroke:#000000;stroke-width:2.0;" width="1662" x="46" y="461.9141"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="61" y="476.4092">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="259" x="122" y="475.333">[kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384))]</text><polygon fill="#FF0000" points="999,541.3203,1009,545.3203,999,549.3203,1003,545.3203" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="545.3203" y2="545.3203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="524.1123">[004]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="479" y="507.7607">ECDH(KEM Pair : kem_handle (G),</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="191" x="527" y="524.1123">KEM ciphertext : kem_ciphertext</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="527" y="540.4639">Destination : memory)</text><polygon fill="#FF0000" points="1513.5,571.6719,1523.5,575.6719,1513.5,579.6719,1517.5,575.6719" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1519.5" y1="575.6719" y2="575.6719"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="570.8154">[005]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1061" y="570.8154">Get KEM Keypair</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="606.0234" y2="606.0234"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="606.0234" y2="619.0234"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="619.0234" y2="619.0234"/><polygon fill="#FF0000" points="1032,615.0234,1022,619.0234,1032,623.0234,1028,619.0234" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="601.167">[006]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="207" x="1061" y="601.167">ECDH KEM Ciphertext with Keypair</text><polygon fill="#FF0000" points="450,645.375,440,649.375,450,653.375,446,649.375" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="649.375" y2="649.375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="644.5186">[007]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="78" x="489" y="644.5186">Put DH result</text><polygon fill="#FF0000" points="450,675.7266,440,679.7266,450,683.7266,446,679.7266" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="679.7266" y2="679.7266"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="674.8701">[008]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="674.8701">done</text><polygon fill="#FF0000" points="999,706.0781,1009,710.0781,999,714.0781,1003,710.0781" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="710.0781" y2="710.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="705.2217">[009]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="269" x="479" y="705.2217">ECC_GetPubKey(KEM Pair : kem_handle (G))</text><polygon fill="#FF0000" points="1513.5,736.4297,1523.5,740.4297,1513.5,744.4297,1517.5,740.4297" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1519.5" y1="740.4297" y2="740.4297"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="735.5732">[010]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="102" x="1061" y="735.5732">Get KEM Keypair</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="770.7813" y2="770.7813"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="770.7813" y2="783.7813"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="783.7813" y2="783.7813"/><polygon fill="#FF0000" points="1032,779.7813,1022,783.7813,1032,787.7813,1028,783.7813" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="765.9248">[011]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="1061" y="765.9248">ECC derive public key</text><polygon fill="#FF0000" points="450,810.1328,440,814.1328,450,818.1328,446,814.1328" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="814.1328" y2="814.1328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="809.2764">[012]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="77" x="489" y="809.2764">Put kem_pub</text><polygon fill="#FF0000" points="450,840.4844,440,844.4844,450,848.4844,446,844.4844" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="844.4844" y2="844.4844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="839.6279">[013]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="839.6279">done</text><path d="M444,857.4844 L444,883.4844 L844,883.4844 L844,867.4844 L834,857.4844 L444,857.4844 " fill="#FBFB77" filter="url(#fg2o76874rb9g)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M834,857.4844 L834,867.4844 L844,867.4844 L834,857.4844 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="379" x="450" y="875.9795">The next steps come from RFC 9180, section 4.1, Decap function</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="914.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="914.0117" y2="914.0117"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="917.0117" y2="917.0117"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="323" x="778" y="902.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="305" x="784" y="920.3311">Derive HPKE pseudo-random key material (PRK)</text><polygon fill="#FF0000" points="999,1004.5938,1009,1008.5938,999,1012.5938,1003,1008.5938" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="1008.5938" y2="1008.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="979.21">[014]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="954.6826">HMAC384(Key : empty,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="292" x="579" y="971.0342">Key Data : "HPKE-v1" | "KEM" | 0x0011 (kem_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="285" x="479" y="987.3857">"                                         eae_prk" | DH result</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="579" y="1003.7373">Destination Slot: Y)</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="1038.9453" y2="1038.9453"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="1038.9453" y2="1051.9453"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="1051.9453" y2="1051.9453"/><polygon fill="#FF0000" points="1032,1047.9453,1022,1051.9453,1032,1055.9453,1028,1051.9453" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1034.0889">[015]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="1061" y="1034.0889">HMAC384 operation</text><polygon fill="#FF0000" points="1626.5,1078.2969,1636.5,1082.2969,1626.5,1086.2969,1630.5,1082.2969" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="1082.2969" y2="1082.2969"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1077.4404">[016]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="1061" y="1077.4404">HMAC384 result PRK</text><polygon fill="#FF0000" points="450,1108.6484,440,1112.6484,450,1116.6484,446,1112.6484" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1112.6484" y2="1112.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1107.792">[017]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="1107.792">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="1141.8242"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1141.8242" y2="1141.8242"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1144.8242" y2="1144.8242"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="187" x="846" y="1130.6484"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="169" x="852" y="1148.1436">Derive HPKE shared secret</text><polygon fill="#FF0000" points="999,1248.7578,1009,1252.7578,999,1256.7578,1003,1252.7578" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="1252.7578" y2="1252.7578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="1215.1982">[018]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="1182.4951">HMAC384(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="293" x="579" y="1198.8467">Data : 0x0030 (big-endian 48) | "HPKE-v1" | "KEM"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="306" x="619" y="1215.1982">0x0011 (kem_id) | "shared_secret" | kem_ciphertext |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="221" x="619" y="1231.5498">kem_pub | 0x01 (HKDF block number)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="579" y="1247.9014">Destination Slot: Y)</text><polygon fill="#FF0000" points="1626.5,1279.1094,1636.5,1283.1094,1626.5,1287.1094,1630.5,1283.1094" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="1283.1094" y2="1283.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1278.2529">[019]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="92" x="1061" y="1278.2529">Get HPKE PRK</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="1313.4609" y2="1313.4609"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="1313.4609" y2="1326.4609"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="1326.4609" y2="1326.4609"/><polygon fill="#FF0000" points="1032,1322.4609,1022,1326.4609,1032,1330.4609,1028,1326.4609" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1308.6045">[020]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="1061" y="1308.6045">HMAC384 slot Y with data</text><polygon fill="#FF0000" points="1626.5,1352.8125,1636.5,1356.8125,1626.5,1360.8125,1630.5,1356.8125" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="1356.8125" y2="1356.8125"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1351.9561">[021]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="178" x="1061" y="1351.9561">HMAC384 result shared secret</text><polygon fill="#FF0000" points="450,1383.1641,440,1387.1641,450,1391.1641,446,1387.1641" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1387.1641" y2="1387.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1382.3076">[022]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="1382.3076">done</text><path d="M46,1413.1641 L107,1413.1641 L107,1421.1641 L97,1431.1641 L46,1431.1641 L46,1413.1641 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;"/><rect fill="none" height="1703.0938" style="stroke:#000000;stroke-width:2.0;" width="1769" x="46" y="1413.1641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="16" x="61" y="1427.6592">alt</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="609" x="122" y="1426.583">[kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384)), kdf_id = 0x0002 (HKDF-SHA384), aead_id = 0x0002 (AES-256-GCM)]</text><path d="M444,1446.5156 L444,1472.5156 L1165,1472.5156 L1165,1456.5156 L1155,1446.5156 L444,1446.5156 " fill="#FBFB77" filter="url(#fg2o76874rb9g)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1155,1446.5156 L1155,1456.5156 L1165,1456.5156 L1155,1446.5156 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="700" x="450" y="1465.0107">The next steps come from RFC 9180, sections 5.1 and 5.2, KeyScheduleBase and ContextR.Open functions respectively</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="1503.043"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1503.043" y2="1503.043"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1506.043" y2="1506.043"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="314" x="782.5" y="1491.8672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="296" x="788.5" y="1509.3623">Derive HPKE psk_id_hash and store in memory</text><polygon fill="#FF0000" points="999,1593.625,1009,1597.625,999,1601.625,1003,1597.625" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="1597.625" y2="1597.625"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="1568.2412">[023]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="1543.7139">HMAC384(Key : empty,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371" x="579" y="1560.0654">Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="619" y="1576.417">0x0002 (aead_id) | "psk_id_hash" | "" (no PSK ID)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="579" y="1592.7686">Destination : memory)</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="1627.9766" y2="1627.9766"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="1627.9766" y2="1640.9766"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="1640.9766" y2="1640.9766"/><polygon fill="#FF0000" points="1032,1636.9766,1022,1640.9766,1032,1644.9766,1028,1640.9766" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1623.1201">[024]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="1061" y="1623.1201">HMAC384 operation</text><polygon fill="#FF0000" points="450,1667.3281,440,1671.3281,450,1675.3281,446,1671.3281" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1671.3281" y2="1671.3281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1666.4717">[025]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="489" y="1666.4717">HMAC384 result psk_id_hash</text><polygon fill="#FF0000" points="450,1697.6797,440,1701.6797,450,1705.6797,446,1701.6797" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1701.6797" y2="1701.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1696.8232">[026]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="1696.8232">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="1730.8555"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1730.8555" y2="1730.8555"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1733.8555" y2="1733.8555"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="298" x="790.5" y="1719.6797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="280" x="796.5" y="1737.1748">Derive HPKE info_hash and store in memory</text><polygon fill="#FF0000" points="999,1821.4375,1009,1825.4375,999,1829.4375,1003,1825.4375" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="1825.4375" y2="1825.4375"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="1796.0537">[027]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="1771.5264">HMAC384(Key : empty,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371" x="579" y="1787.8779">Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="283" x="619" y="1804.2295">0x0002 (aead_id) | "info_hash" | "enable_access"</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="579" y="1820.5811">Destination: memory)</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="1855.7891" y2="1855.7891"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="1855.7891" y2="1868.7891"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="1868.7891" y2="1868.7891"/><polygon fill="#FF0000" points="1032,1864.7891,1022,1868.7891,1032,1872.7891,1028,1868.7891" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="1850.9326">[028]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="1061" y="1850.9326">HMAC384 operation</text><polygon fill="#FF0000" points="450,1895.1406,440,1899.1406,450,1903.1406,446,1899.1406" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1899.1406" y2="1899.1406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1894.2842">[029]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="154" x="489" y="1894.2842">HMAC384 result info_hash</text><polygon fill="#FF0000" points="450,1925.4922,440,1929.4922,450,1933.4922,446,1929.4922" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="1929.4922" y2="1929.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="1924.6357">[030]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="1924.6357">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="1958.668"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1958.668" y2="1958.668"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="1961.668" y2="1961.668"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="267" x="806" y="1947.4922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="249" x="812" y="1964.9873">Derive HPKE secret and store in KV slot</text><polygon fill="#FF0000" points="999,2049.25,1009,2053.25,999,2057.25,1003,2053.25" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="2053.25" y2="2053.25"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="2023.8662">[031]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="1999.3389">HMAC384(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="371" x="579" y="2015.6904">Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="234" x="619" y="2032.042">0x0002 (aead_id) | "secret" | "" (no PSK)</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="579" y="2048.3936">Destination Slot: Y)</text><polygon fill="#FF0000" points="1626.5,2079.6016,1636.5,2083.6016,1626.5,2087.6016,1630.5,2083.6016" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="2083.6016" y2="2083.6016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2078.7451">[032]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="144" x="1061" y="2078.7451">Get HPKE shared secret</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="2113.9531" y2="2113.9531"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="2113.9531" y2="2126.9531"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="2126.9531" y2="2126.9531"/><polygon fill="#FF0000" points="1032,2122.9531,1022,2126.9531,1032,2130.9531,1028,2126.9531" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2109.0967">[033]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="1061" y="2109.0967">HMAC384 slot Y with data</text><polygon fill="#FF0000" points="1626.5,2153.3047,1636.5,2157.3047,1626.5,2161.3047,1630.5,2157.3047" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="2157.3047" y2="2157.3047"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2152.4482">[034]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="135" x="1061" y="2152.4482">HMAC384 result secret</text><polygon fill="#FF0000" points="450,2183.6563,440,2187.6563,450,2191.6563,446,2187.6563" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="2187.6563" y2="2187.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="2182.7998">[035]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="2182.7998">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="2216.832"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2216.832" y2="2216.832"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2219.832" y2="2219.832"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="313" x="783" y="2205.6563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="295" x="789" y="2223.1514">Derive HPKE base_nonce and store in memory</text><polygon fill="#FF0000" points="999,2323.7656,1009,2327.7656,999,2331.7656,1003,2327.7656" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="2327.7656" y2="2327.7656"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="2290.2061">[036]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="2257.5029">HMAC384(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="416" x="579" y="2273.8545">Data : 0x000C (big-endian 12) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="296" x="619" y="2290.2061">0x0002 (kdf_id) | 0x0002 (aead_id) | "base_nonce" |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="619" y="2306.5576">0x00 (HPKE mode) | psk_id_hash | info_hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="124" x="579" y="2322.9092">Destination: memory)</text><polygon fill="#FF0000" points="1626.5,2354.1172,1636.5,2358.1172,1626.5,2362.1172,1630.5,2358.1172" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="2358.1172" y2="2358.1172"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2353.2607">[037]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="1061" y="2353.2607">Get HPKE secret</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="2388.4688" y2="2388.4688"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="2388.4688" y2="2401.4688"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="2401.4688" y2="2401.4688"/><polygon fill="#FF0000" points="1032,2397.4688,1022,2401.4688,1032,2405.4688,1028,2401.4688" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2383.6123">[038]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="1061" y="2383.6123">HMAC384 slot Y with data</text><polygon fill="#FF0000" points="450,2427.8203,440,2431.8203,450,2435.8203,446,2431.8203" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="2431.8203" y2="2431.8203"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="2426.9639">[039]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="169" x="489" y="2426.9639">HMAC384 result base_nonce</text><path d="M1026,2444.8203 L1026,2470.8203 L1283,2470.8203 L1283,2454.8203 L1273,2444.8203 L1026,2444.8203 " fill="#FBFB77" filter="url(#fg2o76874rb9g)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1273,2444.8203 L1273,2454.8203 L1283,2454.8203 L1273,2444.8203 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="236" x="1032" y="2463.3154">The base_nonce is truncated to 12 bytes</text><polygon fill="#FF0000" points="450,2498.5234,440,2502.5234,450,2506.5234,446,2502.5234" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="2502.5234" y2="2502.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="2497.667">[040]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="2497.667">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="2531.6992"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2531.6992" y2="2531.6992"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2534.6992" y2="2534.6992"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="251" x="814" y="2520.5234"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="233" x="820" y="2538.0186">Derive HPKE key and store in KV slot</text><polygon fill="#FF0000" points="999,2638.6328,1009,2642.6328,999,2646.6328,1003,2642.6328" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="2642.6328" y2="2642.6328"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="2605.0732">[041]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="138" x="479" y="2572.3701">HMAC384(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="414" x="579" y="2588.7217">Data : 0x0020 (big-endian 32) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="247" x="619" y="2605.0732">0x0002 (kdf_id) | 0x0002 (aead_id) | "key" |</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="262" x="619" y="2621.4248">0x00 (HPKE mode) | psk_id_hash | info_hash</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="579" y="2637.7764">Destination Slot: Y)</text><polygon fill="#FF0000" points="1626.5,2668.9844,1636.5,2672.9844,1626.5,2676.9844,1630.5,2672.9844" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="2672.9844" y2="2672.9844"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2668.1279">[042]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="101" x="1061" y="2668.1279">Get HPKE secret</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="2703.3359" y2="2703.3359"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="2703.3359" y2="2716.3359"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="2716.3359" y2="2716.3359"/><polygon fill="#FF0000" points="1032,2712.3359,1022,2716.3359,1032,2720.3359,1028,2716.3359" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2698.4795">[043]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="1061" y="2698.4795">HMAC384 slot Y with data</text><polygon fill="#FF0000" points="1626.5,2742.6875,1636.5,2746.6875,1626.5,2750.6875,1630.5,2746.6875" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="2746.6875" y2="2746.6875"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2741.8311">[044]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="1061" y="2741.8311">HMAC384 result key</text><path d="M1026,2759.6875 L1026,2785.6875 L1428,2785.6875 L1428,2769.6875 L1418,2759.6875 L1026,2759.6875 " fill="#FBFB77" filter="url(#fg2o76874rb9g)" style="stroke:#A80036;stroke-width:1.0;"/><path d="M1418,2759.6875 L1418,2769.6875 L1428,2769.6875 L1418,2759.6875 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="381" x="1032" y="2778.1826">The key is truncated to 32 bytes for use as an AES-256-GCM key</text><polygon fill="#FF0000" points="450,2813.3906,440,2817.3906,450,2821.3906,446,2817.3906" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="2817.3906" y2="2817.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="2812.5342">[045]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="2812.5342">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="2846.5664"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2846.5664" y2="2846.5664"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="2849.5664" y2="2849.5664"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="268" x="805.5" y="2835.3906"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="250" x="811.5" y="2852.8857">Decrypt access key and store in KV Slot</text><polygon fill="#FF0000" points="999,2969.8516,1009,2973.8516,999,2977.8516,1003,2973.8516" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="2973.8516" y2="2973.8516"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="2928.1162">[046]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="165" x="479" y="2887.2373">AES-256-GCM(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="98" x="527" y="2903.5889">IV : base_nonce,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="273" x="527" y="2919.9404">Ciphertext : encrypted_access_key_ciphertext,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="196" x="527" y="2936.292">Tag : encrypted_access_key_tag,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="527" y="2952.6436">AAD : "",</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="115" x="527" y="2968.9951">Destination : Slot Z)</text><polygon fill="#FF0000" points="1626.5,3000.2031,1636.5,3004.2031,1626.5,3008.2031,1630.5,3004.2031" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="3004.2031" y2="3004.2031"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="2999.3467">[047]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="86" x="1061" y="2999.3467">Get HPKE key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="3034.5547" y2="3034.5547"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="3034.5547" y2="3047.5547"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="3047.5547" y2="3047.5547"/><polygon fill="#FF0000" points="1032,3043.5547,1022,3047.5547,1032,3051.5547,1028,3047.5547" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3029.6982">[048]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="204" x="1061" y="3029.6982">AES-256-GCM decrypt access key</text><polygon fill="#FF0000" points="1733.5,3073.9063,1743.5,3077.9063,1733.5,3081.9063,1737.5,3077.9063" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1739.5" y1="3077.9063" y2="3077.9063"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3073.0498">[049]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="91" x="1061" y="3073.0498">Put access key</text><polygon fill="#FF0000" points="450,3104.2578,440,3108.2578,450,3112.2578,446,3108.2578" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="3108.2578" y2="3108.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="3103.4014">[050]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="3103.4014">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="3151.4336"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3151.4336" y2="3151.4336"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3154.4336" y2="3154.4336"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="183" x="848" y="3140.2578"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="165" x="854" y="3157.7529">Create the Encryption Key</text><polygon fill="#FF0000" points="999,3225.6641,1009,3229.6641,999,3233.6641,1003,3229.6641" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="3229.6641" y2="3229.6641"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="3208.4561">[051]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="175" x="479" y="3192.1045">HMAC512_Slots(Key : Slot A,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="579" y="3208.4561">Data Key : Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="113" x="579" y="3224.8076">Destination Slot: Y)</text><polygon fill="#FF0000" points="1258,3256.0156,1268,3260.0156,1258,3264.0156,1262,3260.0156" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1264" y1="3260.0156" y2="3260.0156"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3255.1592">[052]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="128" x="1061" y="3255.1592">Get Storage Root Key</text><polygon fill="#FF0000" points="1733.5,3286.3672,1743.5,3290.3672,1733.5,3294.3672,1737.5,3290.3672" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1739.5" y1="3290.3672" y2="3290.3672"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3285.5107">[053]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="96" x="1061" y="3285.5107">Get Access Key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="3320.7188" y2="3320.7188"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="3320.7188" y2="3333.7188"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="3333.7188" y2="3333.7188"/><polygon fill="#FF0000" points="1032,3329.7188,1022,3333.7188,1032,3337.7188,1028,3333.7188" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3315.8623">[054]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="164" x="1061" y="3315.8623">HMAC512 Slot A with Slot Z</text><polygon fill="#FF0000" points="1626.5,3360.0703,1636.5,3364.0703,1626.5,3368.0703,1630.5,3364.0703" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="3364.0703" y2="3364.0703"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3359.2139">[055]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="1061" y="3359.2139">HMAC512 result PMEK</text><polygon fill="#FF0000" points="450,3390.4219,440,3394.4219,450,3398.4219,446,3394.4219" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="3394.4219" y2="3394.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="3389.5654">[056]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="3389.5654">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="3423.5977"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3423.5977" y2="3423.5977"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3426.5977" y2="3426.5977"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="233" x="823" y="3412.4219"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="215" x="829" y="3429.917">Extract PMEK with Encryption Key</text><polygon fill="#FF0000" points="999,3497.8281,1009,3501.8281,999,3505.8281,1003,3501.8281" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="3501.8281" y2="3501.8281"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="3480.6201">[057]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="122" x="479" y="3464.2686">Unwrap(Key : Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="527" y="3480.6201">Data: locked_pmek</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="119" x="527" y="3496.9717">Destination :  Slot Z)</text><polygon fill="#FF0000" points="1626.5,3528.1797,1636.5,3532.1797,1626.5,3536.1797,1630.5,3532.1797" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="3532.1797" y2="3532.1797"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3527.3232">[058]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1061" y="3527.3232">Get Encryption Key</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="3562.5313" y2="3562.5313"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="3562.5313" y2="3575.5313"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="3575.5313" y2="3575.5313"/><polygon fill="#FF0000" points="1032,3571.5313,1022,3575.5313,1032,3579.5313,1028,3575.5313" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3557.6748">[059]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="126" x="1061" y="3557.6748">Decrypt locked_pmek</text><polygon fill="#FF0000" points="1733.5,3601.8828,1743.5,3605.8828,1733.5,3609.8828,1737.5,3605.8828" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1739.5" y1="3605.8828" y2="3605.8828"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3601.0264">[060]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="38" x="1061" y="3601.0264">PMEK</text><polygon fill="#FF0000" points="450,3632.2344,440,3636.2344,450,3640.2344,446,3636.2344" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="3636.2344" y2="3636.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="3631.3779">[061]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="3631.3779">done</text><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="3" style="stroke:#EEEEEE;stroke-width:1.0;" width="1869" x="5" y="3665.4102"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3665.4102" y2="3665.4102"/><line style="stroke:#000000;stroke-width:1.0;" x1="5" x2="1874" y1="3668.4102" y2="3668.4102"/><rect fill="#EEEEEE" filter="url(#fg2o76874rb9g)" height="24.3516" style="stroke:#000000;stroke-width:2.0;" width="298" x="790.5" y="3654.2344"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="280" x="796.5" y="3671.7295">Encrypt PMEK with unlocked Encryption Key</text><polygon fill="#FF0000" points="999,3739.6406,1009,3743.6406,999,3747.6406,1003,3743.6406" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="3743.6406" y2="3743.6406"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="3722.4326">[062]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="106" x="479" y="3706.0811">Wrap(Key: Slot B,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="515" y="3722.4326">Data Key : Slot Z</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="172" x="515" y="3738.7842">Destination : unlocked_pmek)</text><polygon fill="#FF0000" points="1393.5,3769.9922,1403.5,3773.9922,1393.5,3777.9922,1397.5,3773.9922" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1399.5" y1="3773.9922" y2="3773.9922"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3769.1357">[063]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="114" x="1061" y="3769.1357">Get Encryption Key</text><polygon fill="#FF0000" points="1733.5,3800.3438,1743.5,3804.3438,1733.5,3808.3438,1737.5,3804.3438" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1739.5" y1="3804.3438" y2="3804.3438"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3799.4873">[064]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="63" x="1061" y="3799.4873">Get PMEK</text><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1063" y1="3834.6953" y2="3834.6953"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1063" x2="1063" y1="3834.6953" y2="3847.6953"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1022" x2="1063" y1="3847.6953" y2="3847.6953"/><polygon fill="#FF0000" points="1032,3843.6953,1022,3847.6953,1032,3851.6953,1028,3847.6953" style="stroke:#FF0000;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3829.8389">[065]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="156" x="1061" y="3829.8389">Encrypt slot Z using Slot B</text><polygon fill="#FF0000" points="450,3874.0469,440,3878.0469,450,3882.0469,446,3878.0469" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="3878.0469" y2="3878.0469"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="3873.1904">[066]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="93" x="489" y="3873.1904">Unocked PMEK</text><polygon fill="#FF0000" points="999,3920.75,1009,3924.75,999,3928.75,1003,3924.75" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="439" x2="1005" y1="3924.75" y2="3924.75"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="446" y="3911.7178">[067]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="137" x="479" y="3903.542">Purge_key(Key: Slot Y,</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="73" x="543" y="3919.8936">Key : Slot Z)</text><polygon fill="#FF0000" points="1626.5,3951.1016,1636.5,3955.1016,1626.5,3959.1016,1630.5,3955.1016" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1632.5" y1="3955.1016" y2="3955.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3950.2451">[068]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="34" x="1061" y="3950.2451">Purge</text><polygon fill="#FF0000" points="1733.5,3951.1016,1743.5,3955.1016,1733.5,3959.1016,1737.5,3955.1016" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="1021" x2="1739.5" y1="3955.1016" y2="3955.1016"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="1028" y="3950.2451">[069]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="0" x="1065" y="3950.2451"/><polygon fill="#FF0000" points="450,3981.4531,440,3985.4531,450,3989.4531,446,3985.4531" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="444" x2="1010" y1="3985.4531" y2="3985.4531"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="456" y="3980.5967">[070]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="28" x="489" y="3980.5967">done</text><polygon fill="#FF0000" points="267,4028.1563,257,4032.1563,267,4036.1563,263,4032.1563" style="stroke:#FF0000;stroke-width:1.0;"/><line style="stroke:#FF0000;stroke-width:1.0;" x1="261" x2="428" y1="4032.1563" y2="4032.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="273" y="4019.124">[071]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="116" x="306" y="4010.9482">Command response</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="99" x="306" y="4027.2998">Unlocked_PMEK</text><line style="stroke:#008000;stroke-width:1.0;" x1="101" x2="111" y1="4032.1563" y2="4028.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="101" x2="111" y1="4032.1563" y2="4036.1563"/><line style="stroke:#008000;stroke-width:1.0;" x1="101" x2="255" y1="4032.1563" y2="4032.1563"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="29" x="118" y="4019.124">[072]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="151" y="4010.9482">Command</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="53" x="151" y="4027.2998">complete</text><text fill="#888888" font-family="sans-serif" font-size="10" lengthAdjust="spacing" textLength="134" x="929.5" y="4170.3652">Filename: unlock_pmek.uml</text><!--MD5=[8fcef888b5c534876df4583ec60118d7]
@startuml

!include ocp_lock_utils.inc


!if ($show_title)
    Title "Unlock PMEK"
!endif

!if ($show_precond)
    note across
        <b>Preconditions:</b>
        * Access Shared Secret already availble in a slot in KV
        * unlocking key already in a slot and generated on each reset
        <font color=red>Is there a separate Shared Secret per Admin User?</font>
    end note
!endif

srk++ $BUFFER_ACTIVATION
kemg++ $BUFFER_ACTIVATION
pmeks++ $BUFFER_ACTIVATION

fw $async mb++ : UNLOCK_PMEK

!if ($show_api)
    note right mb
        | <b>Field            | <b>Size          | <b>Definition |
        | chksum              | u32              | Little endian |
        | wrapped_access_key  | WrappedAccessKey | KEM-wrapped access key\n* kem_handle\n*kem_algorithm\n*kem_ciphertext\n* encrypted_access_key  |
        | locked_pmek         | EncryptedPmek    | PMEK encrypted to storage root key and access key |
    end note
!endif

mb $async cfw++ : Command

!if ($show_msg_parsing)
    cfw $sync mb : Get command
    mb- -
    $self("cfw", "Determine command")
!else
    mb- -
!endif
cfw $sync cfw: Determine rate of unlocking

alt Storage Root Key exists
    alt Unlocking rate below threshold

        == Get the Access Key ==
        alt kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384))
            cfw $sync kv++: ECDH(KEM Pair : kem_handle (G),\n            KEM ciphertext : kem_ciphertext\n            Destination : memory)
            kv $sync kemg: Get KEM Keypair
            kv $sync kv: ECDH KEM Ciphertext with Keypair
            kv $sync cfw: Put DH result
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            cfw $sync kv++: ECC_GetPubKey(KEM Pair : kem_handle (G))
            kv $sync kemg: Get KEM Keypair
            kv $sync kv: ECC derive public key
            kv $sync cfw: Put kem_pub
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            note right cfw
                The next steps come from RFC 9180, section 4.1, Decap function
            end note

            == Derive HPKE pseudo-random key material (PRK) ==

            cfw $sync kv++: HMAC384(Key : empty,\n                         Key Data : "HPKE-v1" | "KEM" | 0x0011 (kem_id) |\n"                                         eae_prk" | DH result\n                         Destination Slot: Y)
            kv $sync kv: HMAC384 operation
            kv $sync tempy: HMAC384 result PRK
            tempy++ $BUFFER_ACTIVATION
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Derive HPKE shared secret ==

            cfw $sync kv++: HMAC384(Key : Slot Y,\n                         Data : 0x0030 (big-endian 48) | "HPKE-v1" | "KEM" \n                                   0x0011 (kem_id) | "shared_secret" | kem_ciphertext | \n                                   kem_pub | 0x01 (HKDF block number)\n                         Destination Slot: Y)
            kv $sync tempy: Get HPKE PRK
            kv $sync kv: HMAC384 slot Y with data
            kv $sync tempy: HMAC384 result shared secret
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif
        end

        alt kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384)), kdf_id = 0x0002 (HKDF-SHA384), aead_id = 0x0002 (AES-256-GCM)
            note right cfw
                The next steps come from RFC 9180, sections 5.1 and 5.2, KeyScheduleBase and ContextR.Open functions respectively
            end note

            == Derive HPKE psk_id_hash and store in memory ==

            cfw $sync kv++: HMAC384(Key : empty,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "psk_id_hash" | "" (no PSK ID)\n                         Destination : memory)
            kv $sync kv: HMAC384 operation
            kv $sync cfw: HMAC384 result psk_id_hash
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Derive HPKE info_hash and store in memory ==

            cfw $sync kv++: HMAC384(Key : empty,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "info_hash" | "enable_access"\n                         Destination: memory)
            kv $sync kv: HMAC384 operation
            kv $sync cfw: HMAC384 result info_hash
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Derive HPKE secret and store in KV slot ==

            cfw $sync kv++: HMAC384(Key : Slot Y,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "secret" | "" (no PSK)\n                         Destination Slot: Y)
            kv $sync tempy: Get HPKE shared secret
            kv $sync kv: HMAC384 slot Y with data
            kv $sync tempy: HMAC384 result secret
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Derive HPKE base_nonce and store in memory ==

            cfw $sync kv++: HMAC384(Key : Slot Y,\n                         Data : 0x000C (big-endian 12) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | \n                                   0x0002 (kdf_id) | 0x0002 (aead_id) | "base_nonce" | \n                                   0x00 (HPKE mode) | psk_id_hash | info_hash\n                         Destination: memory)
            kv $sync tempy: Get HPKE secret
            kv $sync kv: HMAC384 slot Y with data
            kv $sync cfw: HMAC384 result base_nonce
            note right kv
                The base_nonce is truncated to 12 bytes
            end note
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Derive HPKE key and store in KV slot ==

            cfw $sync kv++: HMAC384(Key : Slot Y,\n                         Data : 0x0020 (big-endian 32) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | \n                                   0x0002 (kdf_id) | 0x0002 (aead_id) | "key" | \n                                   0x00 (HPKE mode) | psk_id_hash | info_hash\n                         Destination Slot: Y)
            kv $sync tempy: Get HPKE secret
            kv $sync kv: HMAC384 slot Y with data
            kv $sync tempy: HMAC384 result key
            note right kv
                The key is truncated to 32 bytes for use as an AES-256-GCM key
            end note
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif

            == Decrypt access key and store in KV Slot ==

            cfw $sync kv++: AES-256-GCM(Key : Slot Y,\n            IV : base_nonce,\n            Ciphertext : encrypted_access_key_ciphertext,\n            Tag : encrypted_access_key_tag,\n            AAD : "",\n            Destination : Slot Z)
            kv $sync tempy: Get HPKE key
            kv $sync kv: AES-256-GCM decrypt access key
            kv $sync tempz: Put access key
            tempz++ $BUFFER_ACTIVATION
            !if ($show_done)
                kv $sync cfw- - : done
            !else
                kv- -
            !endif
        end

        == Create the Encryption Key ==

        cfw $sync kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Z\n                         Destination Slot: Y)
        kv $sync srk: Get Storage Root Key
        kv $sync tempz: Get Access Key
        kv $sync kv: HMAC512 Slot A with Slot Z
        kv $sync tempy: HMAC512 result PMEK
        !if ($show_done)
            kv $sync cfw- - : done
        !else
            kv- -
        !endif

        == Extract PMEK with Encryption Key ==

        cfw $sync kv++: Unwrap(Key : Slot Y,\n            Data: locked_pmek\n            Destination :  Slot Z)
        kv $sync tempy: Get Encryption Key
        kv $sync kv: Decrypt locked_pmek
        kv $sync tempz: PMEK
        !if ($show_done)
            kv $sync cfw- - : done
        !else
            kv- -
        !endif

        == Encrypt PMEK with unlocked Encryption Key ==

        cfw $sync kv++: Wrap(Key: Slot B,\n         Data Key : Slot Z\n         Destination : unlocked_pmek)
        kv $sync pmeks: Get Encryption Key
        kv $sync tempz: Get PMEK
        kv $sync kv: Encrypt slot Z using Slot B
        !if ($show_done)
            kv $sync cfw- - : Unocked PMEK
        !else
            kv- -
        !endif

        cfw $sync kv++: Purge_key(Key: Slot Y,\n                Key : Slot Z)
        kv $sync tempy !! : Purge
        & kv $sync tempz !!
        !if ($show_done)
            kv $sync cfw- - : done
        !else
            kv- -
        !endif

        cfw $sync mb : Command response\nUnlocked_PMEK
        & mb $async fw++ : Command\ncomplete
    end
end

!if ($show_api)
    note right mb
        | <b>Field      | <b>Size       | <b>Definition |
        | chksum        | u32           | Little endian |
        | fips_status   | u32           | Indicates if the command is FIPS approved or an error |
        | unlocked_pmek | EncryptedPmek | PMEK encrypted to an export secret that is rotated  on reset |
    end note
!endif
cfw- -

@enduml

@startuml









	autonumber 1 1  "<b>[000]"

	!pragma teoz true

    participant "Remote Key\nManagement Service" as rkms


    participant "Host" as host


    participant "Storage\nDevice\nFW" as fw

    box "Caliptra"
    	participant "Mail Box" as mb
    	participant "ROM" as crom
    	participant "FW" as cfw
    	participant "ROM to FW\nHandoff Data" as hoff
        participant "DRBG" as rand
        participant "DMA Engine" as dma
        participant "Key Vault" as kv
        participant "Key Vault\nFuses" as fuses
        participant "Key Vault\nStorage Root Key" as gsrk
        participant "Key Vault\nSlot A\n(Storage Root Key)" as srk
        participant "Key Vault\nSlot B\n(PMEK Secret)" as pmeks
        participant "Key Vault\nSlot F\n(DICE Alias Key)\necdsa_secp384r1_sha384" as dice
        participant "Key Vault\nSlot G\n(KEM Keypair)" as kemg
        participant "Key Vault\nSlot W\n(Temporary)" as tempw
        participant "Key Vault\nSlot X\n(MEK Seed)" as meks
        participant "Key Vault\nSlot Y\n(Temporary)" as tempy
        participant "Key Vault\nSlot Z\n(Temporary)" as tempz
        participant "Key Vault\nTemp Memory" as tempmem
    end box

    box "Encryption Engine"
        participant "SFR\nInterface" as sfr
        participant "Control" as ee
        participant "Key Cache" as kc
    end box

    box "Media"
        participant "Create new\Storage Root Key\non NVM subsystem reset" as csrk
        participant "Destroy all\Storage Root Keys\non NVM subsystem reset" as dsrk
    end box

    hide unlinked
	footer Filename: unlock_pmek.uml

	header Version 1



    Title "Unlock PMEK"

    note across
        <b>Preconditions:</b>
        * Access Shared Secret already availble in a slot in KV
        * unlocking key already in a slot and generated on each reset
        <font color=red>Is there a separate Shared Secret per Admin User?</font>
    end note

srk++ #lightblue
kemg++ #lightblue
pmeks++ #lightblue

fw -[#green]>> mb++ : UNLOCK_PMEK


mb -[#green]>> cfw++ : Command

    mb- -
cfw -[#red]> cfw: Determine rate of unlocking

alt Storage Root Key exists
    alt Unlocking rate below threshold

        == Get the Access Key ==
        alt kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384))
            cfw -[#red]> kv++: ECDH(KEM Pair : kem_handle (G),\n            KEM ciphertext : kem_ciphertext\n            Destination : memory)
            kv -[#red]> kemg: Get KEM Keypair
            kv -[#red]> kv: ECDH KEM Ciphertext with Keypair
            kv -[#red]> cfw: Put DH result
                kv -[#red]> cfw- - : done

            cfw -[#red]> kv++: ECC_GetPubKey(KEM Pair : kem_handle (G))
            kv -[#red]> kemg: Get KEM Keypair
            kv -[#red]> kv: ECC derive public key
            kv -[#red]> cfw: Put kem_pub
                kv -[#red]> cfw- - : done

            note right cfw
                The next steps come from RFC 9180, section 4.1, Decap function
            end note

            == Derive HPKE pseudo-random key material (PRK) ==

            cfw -[#red]> kv++: HMAC384(Key : empty,\n                         Key Data : "HPKE-v1" | "KEM" | 0x0011 (kem_id) |\n"                                         eae_prk" | DH result\n                         Destination Slot: Y)
            kv -[#red]> kv: HMAC384 operation
            kv -[#red]> tempy: HMAC384 result PRK
            tempy++ #lightblue
                kv -[#red]> cfw- - : done

            == Derive HPKE shared secret ==

            cfw -[#red]> kv++: HMAC384(Key : Slot Y,\n                         Data : 0x0030 (big-endian 48) | "HPKE-v1" | "KEM" \n                                   0x0011 (kem_id) | "shared_secret" | kem_ciphertext | \n                                   kem_pub | 0x01 (HKDF block number)\n                         Destination Slot: Y)
            kv -[#red]> tempy: Get HPKE PRK
            kv -[#red]> kv: HMAC384 slot Y with data
            kv -[#red]> tempy: HMAC384 result shared secret
                kv -[#red]> cfw- - : done
        end

        alt kem_id = 0x0011 (DHKEM(P-384, HKDF-SHA384)), kdf_id = 0x0002 (HKDF-SHA384), aead_id = 0x0002 (AES-256-GCM)
            note right cfw
                The next steps come from RFC 9180, sections 5.1 and 5.2, KeyScheduleBase and ContextR.Open functions respectively
            end note

            == Derive HPKE psk_id_hash and store in memory ==

            cfw -[#red]> kv++: HMAC384(Key : empty,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "psk_id_hash" | "" (no PSK ID)\n                         Destination : memory)
            kv -[#red]> kv: HMAC384 operation
            kv -[#red]> cfw: HMAC384 result psk_id_hash
                kv -[#red]> cfw- - : done

            == Derive HPKE info_hash and store in memory ==

            cfw -[#red]> kv++: HMAC384(Key : empty,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "info_hash" | "enable_access"\n                         Destination: memory)
            kv -[#red]> kv: HMAC384 operation
            kv -[#red]> cfw: HMAC384 result info_hash
                kv -[#red]> cfw- - : done

            == Derive HPKE secret and store in KV slot ==

            cfw -[#red]> kv++: HMAC384(Key : Slot Y,\n                         Data : "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | 0x0002 (kdf_id) | \n                                   0x0002 (aead_id) | "secret" | "" (no PSK)\n                         Destination Slot: Y)
            kv -[#red]> tempy: Get HPKE shared secret
            kv -[#red]> kv: HMAC384 slot Y with data
            kv -[#red]> tempy: HMAC384 result secret
                kv -[#red]> cfw- - : done

            == Derive HPKE base_nonce and store in memory ==

            cfw -[#red]> kv++: HMAC384(Key : Slot Y,\n                         Data : 0x000C (big-endian 12) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | \n                                   0x0002 (kdf_id) | 0x0002 (aead_id) | "base_nonce" | \n                                   0x00 (HPKE mode) | psk_id_hash | info_hash\n                         Destination: memory)
            kv -[#red]> tempy: Get HPKE secret
            kv -[#red]> kv: HMAC384 slot Y with data
            kv -[#red]> cfw: HMAC384 result base_nonce
            note right kv
                The base_nonce is truncated to 12 bytes
            end note
                kv -[#red]> cfw- - : done

            == Derive HPKE key and store in KV slot ==

            cfw -[#red]> kv++: HMAC384(Key : Slot Y,\n                         Data : 0x0020 (big-endian 32) | "HPKE-v1" | "HPKE" | 0x0011 (kem_id) | \n                                   0x0002 (kdf_id) | 0x0002 (aead_id) | "key" | \n                                   0x00 (HPKE mode) | psk_id_hash | info_hash\n                         Destination Slot: Y)
            kv -[#red]> tempy: Get HPKE secret
            kv -[#red]> kv: HMAC384 slot Y with data
            kv -[#red]> tempy: HMAC384 result key
            note right kv
                The key is truncated to 32 bytes for use as an AES-256-GCM key
            end note
                kv -[#red]> cfw- - : done

            == Decrypt access key and store in KV Slot ==

            cfw -[#red]> kv++: AES-256-GCM(Key : Slot Y,\n            IV : base_nonce,\n            Ciphertext : encrypted_access_key_ciphertext,\n            Tag : encrypted_access_key_tag,\n            AAD : "",\n            Destination : Slot Z)
            kv -[#red]> tempy: Get HPKE key
            kv -[#red]> kv: AES-256-GCM decrypt access key
            kv -[#red]> tempz: Put access key
            tempz++ #lightblue
                kv -[#red]> cfw- - : done
        end

        == Create the Encryption Key ==

        cfw -[#red]> kv++: HMAC512_Slots(Key : Slot A,\n                         Data Key : Slot Z\n                         Destination Slot: Y)
        kv -[#red]> srk: Get Storage Root Key
        kv -[#red]> tempz: Get Access Key
        kv -[#red]> kv: HMAC512 Slot A with Slot Z
        kv -[#red]> tempy: HMAC512 result PMEK
            kv -[#red]> cfw- - : done

        == Extract PMEK with Encryption Key ==

        cfw -[#red]> kv++: Unwrap(Key : Slot Y,\n            Data: locked_pmek\n            Destination :  Slot Z)
        kv -[#red]> tempy: Get Encryption Key
        kv -[#red]> kv: Decrypt locked_pmek
        kv -[#red]> tempz: PMEK
            kv -[#red]> cfw- - : done

        == Encrypt PMEK with unlocked Encryption Key ==

        cfw -[#red]> kv++: Wrap(Key: Slot B,\n         Data Key : Slot Z\n         Destination : unlocked_pmek)
        kv -[#red]> pmeks: Get Encryption Key
        kv -[#red]> tempz: Get PMEK
        kv -[#red]> kv: Encrypt slot Z using Slot B
            kv -[#red]> cfw- - : Unocked PMEK

        cfw -[#red]> kv++: Purge_key(Key: Slot Y,\n                Key : Slot Z)
        kv -[#red]> tempy !! : Purge
        & kv -[#red]> tempz !!
            kv -[#red]> cfw- - : done

        cfw -[#red]> mb : Command response\nUnlocked_PMEK
        & mb -[#green]>> fw++ : Command\ncomplete
    end
end

cfw- -

@enduml

PlantUML version 1.2021.7(Sun May 23 06:40:07 MDT 2021)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Default Encoding: UTF-8
Language: en
Country: US
--></g></svg>