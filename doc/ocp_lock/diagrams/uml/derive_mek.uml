'
' OCP Lock: DERIVE_MEK API sequence diagram showing Caliptra FW/HW interactions
'
'
@startuml

!include utils.inc

note across
    <b>Preconditions:</b>
    * The HEK is present in a KV slot
    * The following sequence has occurred prior: INITIALIZE_MEK_SECRET, then zero or more MIX_MPK
end note

' Pre-existing state
$activate(hek)
$activate(mpk_secret)

dfw -> cfw++ : DERIVE_MEK

$preconditioned_key_extract(HEK, hek, SEK, cfw, EPK, epk)

$preconditioned_key_extract(EPK, epk, DPK, cfw, MEK secret seed, mek_secret_seed)

$zeroize(epk)

$preconditioned_key_extract(MPK secret, mpk_secret, MEK secret seed, mek_secret_seed, MEK secret, mek_secret)

$zeroize(mek_secret_seed)
$zeroize(mpk_secret)

$kdf(cfw, MEK secret, mek_secret, derivation constant, MEK, mek)

$zeroize(mek_secret)

cfw -> sfr : Read Control Reg

alt (DN == 1b || ERR == 1b || EXE == 1b)
    cfw -> sfr : Write Control Reg (DN = 1b)

    cfw -> cfw : Start timeout
    cfw -> sfr : Read Control Reg
    group loop until (rdy_timeout or (DN == 0b && ERR == 0b && EXE == 0b))
        cfw -> sfr : Read Control Reg
    end
end

group in any order
    cfw -> dma++ : MEK Write (Slot: Y)
    dma -> mek : Read MEK
    dma -> sfr : Write MEK
    note left sfr
        If the MEK is larger than the encryption engine requires,
        then the encryption engine truncates the MEK
    end note
    dma -> cfw-- : complete

    cfw -> sfr : Write Aux
    cfw -> sfr : Write Metadata
end

cfw -> sfr : Write Control Reg (CMD = Load_MEK, DN = 0, EXE = 1)
cfw -> cfw : Start timeout

group in any oder
    ee -> sfr : Read MEK
    ee -> sfr : Read AUX
    ee -> sfr : Read Metadata
end

ee -> kc : Store MEK

group loop until (cmd_timeout or DN = 1b)
    ee -> sfr-- : Write Control Reg\n(DN = 1b,\n ERR = 0b,\n EXE = 0b)
    cfw -> sfr : Read Control Reg
end
sfr--

cfw -> sfr : Write Control Reg (DN = 1b)
note left sfr: Reset the SFR interface for next operation - not waiting for response

$zeroize(mek)

cfw -> dfw : Command response\n\
 (Status = Control Reg\n\
                Error field)
cfw--

@enduml
