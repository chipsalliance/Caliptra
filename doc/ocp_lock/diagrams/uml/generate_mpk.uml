'
' OCP Lock: GENERATE_MPK API sequence diagram showing Caliptra FW/HW interactions
'
'
@startuml

!include utils.inc

note across
    <b>Preconditions:</b>
        * The HEK is present in a KV slot
end note

' Pre-existing state
$activate(hek)
$activate(hpke)

dfw -> cfw++ : GENERATE_MPK

$preconditioned_key_extract(HEK, hek, SEK, cfw, EPK, epk)

$hpke_unwrap(kv_ak, "")

$preconditioned_key_extract(Access key, kv_ak, EPK, epk, Locked MPK Encryption Secret, encryption_secret)

$zeroize(epk)
$zeroize(kv_ak)

cfw -> drbg: Get random 256-bit MEK

$preconditioned_aes_encrypt(encryption_secret, encryption_key, MPK, cfw)

cfw -> dfw: Command response\nand Locked MPK
cfw--

@enduml
