'
' OCP Lock: ENABLE_MPK API sequence diagram showing Caliptra FW/HW interactions
'
@startuml

!include utils.inc

note across
    <b>Preconditions:</b>
        * The HEK is present in a KV slot
end note

' Pre-existing state
$activate_kv(hek)
$activate(hpke)
$activate_kv(fw_cdi)

dfw -> cfw++ : ENABLE_MPK

alt Enabled MPK Encryption Secret not yet initialized
    cfw -> drbg: Get random 256-bit seed

    $kdf(cfw, "Firmware DICE CDI", fw_cdi, derivation constant, derivation key, dkey)

    cfw -> hmac++: Derive Enabled MPK Encryption Secret
    cfw -> hmac: Write random seed
    hmac -> dkey: Read derivation key
    hmac -> enabled_mpk_encryption_secret ** : Write HMAC(derivation key, random seed)
    $activate_kv(enabled_mpk_encryption_secret)
    hmac -> cfw: Done
    hmac--

    $zeroize(dkey)
end

cfw -> sek **: Populate SEK from mailbox command
$activate(sek)

$preconditioned_key_extract(HEK, hek, SEK, sek, EPK, epk)

$zeroize(sek)

$hpke_unwrap(ak, "")

$preconditioned_key_extract(Access key, ak, EPK, epk, Locked MPK Encryption Secret, encryption_secret)

$zeroize(epk)
$zeroize(ak)

$preconditioned_aes_decrypt(encryption_secret, encryption_key, locked MPK, mpk)

$preconditioned_aes_encrypt(enabled_mpk_encryption_secret, enabled_mpk_encryption_key, ready MPK, mpk)

cfw -> dfw: Command response\nand Enabled MPK
cfw--

@enduml
